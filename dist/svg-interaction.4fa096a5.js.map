{"version":3,"sources":["svg-interaction.js"],"names":["init","document","readyState","addEventListener","setupInteractions","chartPanels","id","svgSelector","title","type","forEach","panel","panelEl","getElementById","img","querySelector","complete","setTimeout","setupImagePanelInteraction","imgSelector","setupPanelInteraction","addGlobalStyles","observeSvgChanges","observer","MutationObserver","mutations","mutation","addedNodes","length","node","nodeType","svg","tagName","closest","chartContent","hasAttribute","_panel$querySelector","panelId","textContent","trim","includes","concat","querySelectorAll","observe","childList","subtree","setAttribute","style","transition","cursor","position","zIndex","transform","boxShadow","e","_e$target$closest","_e$target","target","call","openSvgInNewWindow","addHintText","console","warn","log","src","overflow","_e$target$closest2","_e$target2","imageSrc","startsWith","baseUrl","window","location","origin","pathname","replace","openImageInNewWindow","container","hint","createElement","className","innerHTML","cssText","appendChild","opacity","selectors","split","map","s","svgElement","container3D","container2D","isVisible","el","getComputedStyle","display","visibility","rect","getBoundingClientRect","width","height","is2DVisible","is3DVisible","pickSvgIf2D","rectCells","cellGroups","pickSvgIf3D","_iterator","_createForOfIteratorHelper","_step","n","done","selector","value","toUpperCase","err","f","svg2D","isActually2D","svg3D","error","sel","d3","select","selectAll","each","path","d","datum","properties","event","MouseEvent","bubbles","dispatchEvent","storeDataInAttributes","proceedWithNewWindow","clonedSvg","cloneNode","svgWidth","getAttribute","clientWidth","svgHeight","clientHeight","viewBox","removeAttribute","pointerEvents","allElements","serializer","XMLSerializer","svgString","serializeToString","mapLegendHTML","legendEl","heatmapLegendHTML","d3LocalUrl","d3LocalScript","html","createNewWindowHTML","newWindow","open","write","close","alert","circles","circle","data","scrapedInfo","scraped_info","name","attr","Object","keys","JSON","stringify","depth","undefined","children","ancestors","total_plays","total_comments","rate","influence","paths","storedCount","group","genre","month","genreIdx","monthIdx","classAttr","match","parseInt","months","allGenres","trackCount","Math","round","cells","cellCount","cell","linePaths","lineCount","lineData","Array","isArray","values","p","idx","_typeof","filter","v","normalizeCountryName","ALIASES","Map","trimmed","get","arguments","interactionScript","heatmapInitCode","initInteractionsInNewWindow","styleId","head"],"mappings":"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","file":"svg-interaction.4fa096a5.js","sourceRoot":"..\\src","sourcesContent":["// ==============================\n// SVG äº¤äº’åŠŸèƒ½ï¼šhover æ”¾å¤§ + ç‚¹å‡»æ–°çª—å£æ‰“å¼€ï¼ˆä¿ç•™äº¤äº’åŠŸèƒ½ï¼‰\n// ==============================\n(function() {\n  'use strict';\n\n  // ç­‰å¾… DOM åŠ è½½å®Œæˆ\n  function init() {\n    if (document.readyState === 'loading') {\n      document.addEventListener('DOMContentLoaded', setupInteractions);\n    } else {\n      setupInteractions();\n    }\n  }\n\n  function setupInteractions() {\n    // ä¸ºæ‰€æœ‰å›¾è¡¨é¢æ¿æ·»åŠ äº¤äº’åŠŸèƒ½\n    const chartPanels = [\n      { id: 'panel-tree', svgSelector: '#tree', title: 'Genre Hierarchy', type: 'tree' },\n      { id: 'panel-bubble', svgSelector: '#bubble-svg', title: 'Impact Bubbles', type: 'bubble' },\n      { id: 'panel-map', svgSelector: '#map svg', title: 'Geographic Distribution', type: 'map' },\n      { id: 'panel-heatmap', svgSelector: '#heatmap-3d svg, #heatmap-2d svg', title: 'Trend Heatmap', type: 'heatmap' },\n      // è¯äº‘ç”± JS æ¸²æŸ“ä¸º SVGï¼ˆä¸å†æ˜¯ IMGï¼‰\n      { id: 'panel-img-1', svgSelector: '#wordcloud svg', title: 'Word Cloud Analysis', type: 'wordcloud' },\n      // åŸæœ¬æ˜¯å›¾ç‰‡æŸ±çŠ¶å›¾ï¼Œç°æ”¹ä¸º SVGï¼ˆæ”¯æŒç‚¹å‡»æ”¾å¤§/æ–°çª—å£ï¼‰\n      { id: 'panel-img-2', svgSelector: '#genre-bar-svg', title: 'Statistical Ranking', type: 'bar' }\n    ];\n\n    chartPanels.forEach(panel => {\n      // å»¶è¿Ÿè®¾ç½®ï¼Œç­‰å¾… SVG/å›¾ç‰‡åŠ è½½å®Œæˆ\n      if (panel.type === 'image') {\n        // å›¾ç‰‡éœ€è¦ç­‰å¾…åŠ è½½å®Œæˆ\n        const panelEl = document.getElementById(panel.id);\n        if (panelEl) {\n          const img = panelEl.querySelector('img');\n          if (img) {\n            if (img.complete) {\n              // å›¾ç‰‡å·²åŠ è½½\n              setTimeout(() => {\n                setupImagePanelInteraction(panel.id, panel.imgSelector, panel.title);\n              }, 100);\n            } else {\n              // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ\n              img.addEventListener('load', function() {\n                setTimeout(() => {\n                  setupImagePanelInteraction(panel.id, panel.imgSelector, panel.title);\n                }, 100);\n              });\n              // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•è®¾ç½®ï¼ˆå¯èƒ½å›¾ç‰‡è·¯å¾„æœ‰é—®é¢˜ï¼‰\n              img.addEventListener('error', function() {\n                setTimeout(() => {\n                  setupImagePanelInteraction(panel.id, panel.imgSelector, panel.title);\n                }, 100);\n              });\n            }\n          } else {\n            // å¦‚æœæ‰¾ä¸åˆ°å›¾ç‰‡ï¼Œå»¶è¿Ÿåé‡è¯•\n            setTimeout(() => {\n              setupImagePanelInteraction(panel.id, panel.imgSelector, panel.title);\n            }, 1000);\n          }\n        }\n      } else {\n        setTimeout(() => {\n          setupPanelInteraction(panel.id, panel.svgSelector, panel.title, panel.type);\n        }, 500);\n      }\n    });\n\n    // æ·»åŠ å…¨å±€æ ·å¼\n    addGlobalStyles();\n\n    // ç›‘å¬åŠ¨æ€æ·»åŠ çš„ SVGï¼ˆå¦‚çƒ­åŠ›å›¾åˆ‡æ¢ï¼‰\n    observeSvgChanges();\n  }\n\n  function observeSvgChanges() {\n    // ä½¿ç”¨ MutationObserver ç›‘å¬ SVG çš„å˜åŒ–\n    const observer = new MutationObserver(function(mutations) {\n      mutations.forEach(function(mutation) {\n        if (mutation.addedNodes.length) {\n          // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ SVG è¢«æ·»åŠ \n          mutation.addedNodes.forEach(function(node) {\n            if (node.nodeType === 1) { // Element node\n              const svg = node.tagName === 'svg' ? node : node.querySelector('svg');\n              if (svg) {\n                const panel = svg.closest('.chart-panel');\n                if (panel) {\n                  const chartContent = panel.querySelector('.chart-content');\n                  if (chartContent && !chartContent.hasAttribute('data-interaction-setup')) {\n                    const panelId = panel.id;\n                    const title = panel.querySelector('.panel-header')?.textContent?.trim() || 'Chart';\n                    let type = 'default';\n                    // âœ… å…ˆæ£€æŸ¥æ›´å…·ä½“çš„ç±»å‹ï¼ˆheatmap åŒ…å« 'map'ï¼Œæ‰€ä»¥è¦å…ˆæ£€æŸ¥ï¼‰\n                    if (panelId.includes('heatmap')) type = 'heatmap';\n                    else if (panelId.includes('tree')) type = 'tree';\n                    else if (panelId.includes('bubble')) type = 'bubble';\n                    else if (panelId.includes('map')) type = 'map';\n                    setupPanelInteraction(panelId, `#${panelId} svg`, title, type);\n                  }\n                }\n              }\n            }\n          });\n        }\n      });\n    });\n\n    // è§‚å¯Ÿæ‰€æœ‰å›¾è¡¨é¢æ¿\n    document.querySelectorAll('.chart-panel').forEach(panel => {\n      observer.observe(panel, { childList: true, subtree: true });\n    });\n  }\n\n  function setupPanelInteraction(panelId, svgSelector, title, type) {\n    const panel = document.getElementById(panelId);\n    if (!panel) return;\n\n    const chartContent = panel.querySelector('.chart-content');\n    if (!chartContent) return;\n\n    // é¿å…é‡å¤è®¾ç½®\n    if (chartContent.hasAttribute('data-interaction-setup')) return;\n    chartContent.setAttribute('data-interaction-setup', 'true');\n\n    // æ·»åŠ  hover æ”¾å¤§æ•ˆæœ\n    chartContent.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';\n    chartContent.style.cursor = 'pointer';\n    chartContent.style.position = 'relative';\n    chartContent.style.zIndex = '1';\n\n    // Hover æ•ˆæœ\n    chartContent.addEventListener('mouseenter', function() {\n      this.style.transform = 'scale(1.05)';\n      this.style.boxShadow = '0 8px 32px rgba(88, 101, 242, 0.4)';\n      this.style.zIndex = '100';\n    });\n\n    chartContent.addEventListener('mouseleave', function() {\n      this.style.transform = 'scale(1)';\n      this.style.boxShadow = 'none';\n      this.style.zIndex = '1';\n    });\n\n    // ç‚¹å‡»åœ¨æ–°çª—å£æ‰“å¼€ SVG\n    chartContent.addEventListener('click', function(e) {\n      // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–å…¶ä»–äº¤äº’å…ƒç´ ï¼Œä¸è§¦å‘\n      if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {\n        return;\n      }\n      // âœ… çƒ­åŠ›å›¾æ³¨é‡Šï¼šå±äºé¢æ¿å†…äº¤äº’æ§ä»¶ï¼Œç¦æ­¢è§¦å‘â€œç‚¹å‡»æ‰“å¼€å¤§å›¾â€\n      // å…¸å‹å‘½ä¸­ï¼š<details class=\"hm-anno\"> / <summary>\n      if (\n        e.target.closest?.('.hm-anno') ||\n        e.target.tagName === 'DETAILS' ||\n        e.target.tagName === 'SUMMARY'\n      ) {\n        return;\n      }\n\n      openSvgInNewWindow(svgSelector, title, type);\n    });\n\n    // æ·»åŠ æç¤ºæ–‡å­—\n    addHintText(chartContent, title);\n  }\n\n  function setupImagePanelInteraction(panelId, imgSelector, title) {\n    const panel = document.getElementById(panelId);\n    if (!panel) {\n      console.warn(`æœªæ‰¾åˆ°é¢æ¿: ${panelId}`);\n      return;\n    }\n\n    const chartContent = panel.querySelector('.chart-content');\n    if (!chartContent) {\n      console.warn(`æœªæ‰¾åˆ° chart-content: ${panelId}`);\n      return;\n    }\n\n    // æŸ¥æ‰¾å›¾ç‰‡å…ƒç´ ï¼ˆä½¿ç”¨æ›´é€šç”¨çš„é€‰æ‹©å™¨ï¼‰\n    const img = chartContent.querySelector('img.chart-img') || chartContent.querySelector('img');\n    if (!img) {\n      console.warn(`æœªæ‰¾åˆ°å›¾ç‰‡å…ƒç´ : ${panelId}`);\n      return;\n    }\n\n    // é¿å…é‡å¤è®¾ç½®\n    if (chartContent.hasAttribute('data-interaction-setup')) {\n      console.log(`å›¾ç‰‡äº¤äº’å·²è®¾ç½®: ${panelId}`);\n      return;\n    }\n    chartContent.setAttribute('data-interaction-setup', 'true');\n\n    console.log(`âœ… è®¾ç½®å›¾ç‰‡äº¤äº’: ${panelId}, å›¾ç‰‡: ${img.src}`);\n\n    // æ·»åŠ  hover æ”¾å¤§æ•ˆæœ\n    chartContent.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';\n    chartContent.style.cursor = 'pointer';\n    chartContent.style.position = 'relative';\n    chartContent.style.zIndex = '1';\n    chartContent.style.overflow = 'hidden';\n\n    // Hover æ•ˆæœ\n    chartContent.addEventListener('mouseenter', function() {\n      this.style.transform = 'scale(1.05)';\n      this.style.boxShadow = '0 8px 32px rgba(88, 101, 242, 0.4)';\n      this.style.zIndex = '100';\n    });\n\n    chartContent.addEventListener('mouseleave', function() {\n      this.style.transform = 'scale(1)';\n      this.style.boxShadow = 'none';\n      this.style.zIndex = '1';\n    });\n\n    // ç‚¹å‡»åœ¨æ–°çª—å£æ‰“å¼€å›¾ç‰‡\n    chartContent.addEventListener('click', function(e) {\n      // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®æˆ–å…¶ä»–äº¤äº’å…ƒç´ ï¼Œä¸è§¦å‘\n      if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {\n        return;\n      }\n      // âœ… é˜²æ­¢æœªæ¥å›¾ç‰‡é¢æ¿ä¹ŸåŠ ç±»ä¼¼æ³¨é‡Šæ§ä»¶åè¯¯è§¦å‘æ‰“å¼€\n      if (\n        e.target.closest?.('.hm-anno') ||\n        e.target.tagName === 'DETAILS' ||\n        e.target.tagName === 'SUMMARY'\n      ) {\n        return;\n      }\n\n      // è·å–å›¾ç‰‡çš„å®é™…è·¯å¾„ï¼ˆå¤„ç†ç›¸å¯¹è·¯å¾„ï¼‰\n      let imageSrc = img.src;\n      // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºç»å¯¹è·¯å¾„\n      if (imageSrc.startsWith('http://') || imageSrc.startsWith('https://') || imageSrc.startsWith('data:')) {\n        // å·²ç»æ˜¯ç»å¯¹è·¯å¾„æˆ– data URL\n      } else {\n        // ç›¸å¯¹è·¯å¾„ï¼Œä½¿ç”¨å½“å‰é¡µé¢çš„ base URL\n        const baseUrl = window.location.origin + window.location.pathname.replace(/\\/[^/]*$/, '/');\n        if (!imageSrc.startsWith('/')) {\n          imageSrc = baseUrl + imageSrc;\n        } else {\n          imageSrc = window.location.origin + imageSrc;\n        }\n      }\n\n      openImageInNewWindow(imageSrc, title);\n    });\n\n    // æ·»åŠ æç¤ºæ–‡å­—\n    addHintText(chartContent, title);\n  }\n\n  function addHintText(container, title) {\n    // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†æç¤º\n    if (container.querySelector('.svg-hint')) return;\n\n    const hint = document.createElement('div');\n    hint.className = 'svg-hint';\n    hint.innerHTML = 'ğŸ’¡ æ‚¬åœæ”¾å¤§ | ç‚¹å‡»æŸ¥çœ‹å¤§å›¾';\n    hint.style.cssText = `\n      position: absolute;\n      top: 8px;\n      right: 8px;\n      background: rgba(15, 23, 42, 0.9);\n      color: #e2e8f0;\n      padding: 6px 12px;\n      border-radius: 4px;\n      font-size: 11px;\n      pointer-events: none;\n      z-index: 10;\n      border: 1px solid rgba(88, 101, 242, 0.5);\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    `;\n\n    container.appendChild(hint);\n\n    // é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæç¤º\n    container.addEventListener('mouseenter', function() {\n      hint.style.opacity = '1';\n    });\n\n    container.addEventListener('mouseleave', function() {\n      hint.style.opacity = '0';\n    });\n  }\n\n  function openSvgInNewWindow(svgSelector, title, type) {\n    // âœ… è°ƒè¯•ï¼šç¡®è®¤ type å‚æ•°\n    console.log('ğŸ“ [openSvgInNewWindow] æ¥æ”¶åˆ°çš„ç±»å‹:', type, 'é€‰æ‹©å™¨:', svgSelector);\n    \n    // æŸ¥æ‰¾ SVG å…ƒç´ ï¼ˆæ”¯æŒå¤šä¸ªé€‰æ‹©å™¨ï¼Œå–ç¬¬ä¸€ä¸ªå­˜åœ¨çš„ï¼‰\n    const selectors = svgSelector.split(',').map(s => s.trim());\n    let svgElement = null;\n\n    // âœ… çƒ­åŠ›å›¾ï¼šå¿…é¡»æŒ‰â€œå½“å‰å¯è§â€çš„å®¹å™¨ä¼˜å…ˆé€‰æ‹©ï¼ˆå¦åˆ™ querySelector ä¼šå…ˆå‘½ä¸­éšè—çš„ 3D SVGï¼‰\n    if (type === 'heatmap') {\n      const container3D = document.querySelector('#heatmap-3d');\n      const container2D = document.querySelector('#heatmap-2d');\n\n      const isVisible = (el) => {\n        if (!el) return false;\n        const style = window.getComputedStyle(el);\n        if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') return false;\n        const rect = el.getBoundingClientRect();\n        return rect.width > 0 && rect.height > 0;\n      };\n\n      const is2DVisible = isVisible(container2D);\n      const is3DVisible = isVisible(container3D);\n\n      console.log('ğŸ“Š å®¹å™¨å¯è§æ€§æ£€æŸ¥(ç”¨äºæ–°çª—å£æ‰“å¼€):', {\n        '2Då®¹å™¨å­˜åœ¨': !!container2D,\n        '2Då®¹å™¨æ˜¾ç¤º': is2DVisible,\n        '3Då®¹å™¨å­˜åœ¨': !!container3D,\n        '3Då®¹å™¨æ˜¾ç¤º': is3DVisible\n      });\n\n      const pickSvgIf2D = (container) => {\n        if (!container) return null;\n        const svg = container.querySelector('svg');\n        if (!svg) return null;\n        const rectCells = svg.querySelectorAll('rect.cell');\n        const cellGroups = svg.querySelectorAll('g[class*=\"cell-group\"]');\n        return rectCells.length > 0 && cellGroups.length === 0 ? svg : null;\n      };\n\n      const pickSvgIf3D = (container) => {\n        if (!container) return null;\n        const svg = container.querySelector('svg');\n        if (!svg) return null;\n        const cellGroups = svg.querySelectorAll('g[class*=\"cell-group\"]');\n        return cellGroups.length > 0 ? svg : null;\n      };\n\n      // å½“å‰æ˜¾ç¤ºçš„ä¼˜å…ˆ\n      if (is2DVisible) svgElement = pickSvgIf2D(container2D);\n      if (!svgElement && is3DVisible) svgElement = pickSvgIf3D(container3D);\n      // å…œåº•ï¼šæŒ‰å†…å®¹ç±»å‹\n      if (!svgElement) svgElement = pickSvgIf2D(container2D) || pickSvgIf3D(container3D);\n    }\n\n    // éçƒ­åŠ›å›¾ï¼ˆæˆ–çƒ­åŠ›å›¾æœªæ‰¾åˆ°ï¼‰æ‰ç”¨é€‰æ‹©å™¨å…œåº•\n    if (!svgElement) {\n      for (const selector of selectors) {\n        svgElement = document.querySelector(selector);\n        if (svgElement && svgElement.tagName && svgElement.tagName.toUpperCase() === 'SVG') {\n          console.log(`âœ… æ‰¾åˆ° SVG: ${selector}`);\n          break;\n        } else if (svgElement) {\n          // å¦‚æœä¸æ˜¯SVGï¼Œç»§ç»­æŸ¥æ‰¾\n          svgElement = null;\n        }\n      }\n    }\n    \n    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨çƒ­åŠ›å›¾å®¹å™¨ä¸­æŸ¥æ‰¾\n    if (!svgElement && type === 'heatmap') {\n      console.log('ğŸ” çƒ­åŠ›å›¾ï¼šåœ¨é€‰æ‹©å™¨ä¸­æœªæ‰¾åˆ°SVGï¼Œå°è¯•åœ¨å®¹å™¨ä¸­æŸ¥æ‰¾...');\n      const container3D = document.querySelector('#heatmap-3d');\n      const container2D = document.querySelector('#heatmap-2d');\n      \n      // âœ… ä¼˜å…ˆæŸ¥æ‰¾å½“å‰æ˜¾ç¤ºçš„å®¹å™¨ï¼ˆ2Dä¼˜å…ˆï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½åˆ‡æ¢åˆ°äº†2Dï¼‰\n      // ä½¿ç”¨ getComputedStyle æ£€æŸ¥å®é™…æ˜¾ç¤ºçŠ¶æ€ï¼ˆåŒ…æ‹¬CSSç±»è®¾ç½®çš„displayï¼‰\n      const is2DVisible = container2D && window.getComputedStyle(container2D).display !== 'none';\n      const is3DVisible = container3D && window.getComputedStyle(container3D).display !== 'none';\n      \n      console.log('ğŸ“Š å®¹å™¨çŠ¶æ€æ£€æŸ¥:', {\n        '2Då®¹å™¨å­˜åœ¨': !!container2D,\n        '2Då®¹å™¨æ˜¾ç¤º': is2DVisible,\n        '2Då®¹å™¨å†…è”æ ·å¼': container2D ? container2D.style.display : 'N/A',\n        '2Då®¹å™¨è®¡ç®—æ ·å¼': container2D ? window.getComputedStyle(container2D).display : 'N/A',\n        '3Då®¹å™¨å­˜åœ¨': !!container3D,\n        '3Då®¹å™¨æ˜¾ç¤º': is3DVisible,\n        '3Då®¹å™¨å†…è”æ ·å¼': container3D ? container3D.style.display : 'N/A',\n        '3Då®¹å™¨è®¡ç®—æ ·å¼': container3D ? window.getComputedStyle(container3D).display : 'N/A'\n      });\n      \n      // âœ… ä¿®å¤ï¼šä¸¥æ ¼æŒ‰ç…§æ˜¾ç¤ºçŠ¶æ€å’Œå†…å®¹ç±»å‹é€‰æ‹©SVG\n      if (is2DVisible) {\n        const svg2D = container2D.querySelector('svg');\n        if (svg2D) {\n          // âœ… ä¸¥æ ¼éªŒè¯ï¼šå¿…é¡»æ˜¯2Dçƒ­åŠ›å›¾ï¼ˆæœ‰rect.cellä¸”æ²¡æœ‰cell-groupï¼‰\n          const rectCells = svg2D.querySelectorAll('rect.cell');\n          const cellGroups = svg2D.querySelectorAll('g[class*=\"cell-group\"]');\n          const isActually2D = rectCells.length > 0 && cellGroups.length === 0;\n          \n          console.log('ğŸ“Š 2Då®¹å™¨éªŒè¯:', {\n            'rect.cellæ•°é‡': rectCells.length,\n            'cell-groupæ•°é‡': cellGroups.length,\n            'æ˜¯çœŸæ­£çš„2Dçƒ­åŠ›å›¾': isActually2D\n          });\n          \n          if (isActually2D) {\n            svgElement = svg2D;\n            console.log('âœ… é€‰æ‹©2Dçƒ­åŠ›å›¾SVGï¼ˆå½“å‰æ˜¾ç¤ºï¼‰');\n          } else {\n            console.warn('âš ï¸ 2Då®¹å™¨ä¸­çš„SVGä¸æ˜¯2Dçƒ­åŠ›å›¾ï¼Œè·³è¿‡');\n          }\n        } else {\n          console.warn('âš ï¸ heatmap-2då®¹å™¨ä¸­æ²¡æœ‰SVGå…ƒç´ ');\n        }\n      }\n      \n      // âœ… åªæœ‰åœ¨2Dä¸å¯ç”¨æˆ–ä¸æ˜¯çœŸæ­£çš„2Dæ—¶ï¼Œæ‰é€‰æ‹©3D\n      if (!svgElement && is3DVisible) {\n        const svg3D = container3D.querySelector('svg');\n        if (svg3D) {\n          // âœ… éªŒè¯ï¼šå¿…é¡»æ˜¯3Dçƒ­åŠ›å›¾ï¼ˆæœ‰cell-groupï¼‰\n          const cellGroups = svg3D.querySelectorAll('g[class*=\"cell-group\"]');\n          if (cellGroups.length > 0) {\n            svgElement = svg3D;\n            console.log('âœ… é€‰æ‹©3Dçƒ­åŠ›å›¾SVGï¼ˆå½“å‰æ˜¾ç¤ºï¼‰');\n          } else {\n            console.warn('âš ï¸ 3Då®¹å™¨ä¸­çš„SVGä¸æ˜¯3Dçƒ­åŠ›å›¾');\n          }\n        } else {\n          console.warn('âš ï¸ heatmap-3då®¹å™¨ä¸­æ²¡æœ‰SVGå…ƒç´ ');\n        }\n      }\n      \n      // âœ… å¦‚æœå½“å‰æ˜¾ç¤ºçš„å®¹å™¨éƒ½æ²¡æœ‰åˆé€‚çš„SVGï¼Œå°è¯•æŸ¥æ‰¾éšè—çš„å®¹å™¨\n      if (!svgElement) {\n        // å…ˆå°è¯•2Dï¼ˆéšè—çš„ï¼‰\n        if (container2D) {\n          const svg2D = container2D.querySelector('svg');\n          if (svg2D) {\n            const rectCells = svg2D.querySelectorAll('rect.cell');\n            const cellGroups = svg2D.querySelectorAll('g[class*=\"cell-group\"]');\n            if (rectCells.length > 0 && cellGroups.length === 0) {\n              svgElement = svg2D;\n              console.log('âœ… é€‰æ‹©2Dçƒ­åŠ›å›¾SVGï¼ˆéšè—å®¹å™¨ï¼‰');\n            }\n          }\n        }\n        \n        // å†å°è¯•3Dï¼ˆéšè—çš„ï¼‰\n        if (!svgElement && container3D) {\n          const svg3D = container3D.querySelector('svg');\n          if (svg3D) {\n            const cellGroups = svg3D.querySelectorAll('g[class*=\"cell-group\"]');\n            if (cellGroups.length > 0) {\n              svgElement = svg3D;\n              console.log('âœ… é€‰æ‹©3Dçƒ­åŠ›å›¾SVGï¼ˆéšè—å®¹å™¨ï¼‰');\n            }\n          }\n        }\n      }\n    }\n    \n    if (!svgElement) {\n      console.error(`âŒ æœªæ‰¾åˆ° SVG: ${svgSelector}, type: ${type}`);\n      // è¾“å‡ºè°ƒè¯•ä¿¡æ¯\n      selectors.forEach(sel => {\n        const el = document.querySelector(sel);\n        console.log(`  - é€‰æ‹©å™¨ \"${sel}\": ${el ? (el.tagName || 'æœªçŸ¥') : 'æœªæ‰¾åˆ°'}`);\n      });\n      return;\n    }\n\n    // åœ¨å…‹éš†å‰ï¼Œå°†æ•°æ®å­˜å‚¨åˆ° data å±æ€§ä¸­\n    // å¯¹äºåœ°å›¾ï¼Œå…ˆè§¦å‘ä¸€æ¬¡æ‰€æœ‰å…ƒç´ çš„ mouseenter ä»¥ç¡®ä¿æ•°æ®è¢«å­˜å‚¨\n    if (type === 'map') {\n      d3.select(svgElement).selectAll('path').each(function() {\n        const path = d3.select(this);\n        const d = path.datum();\n        if (d && d.properties) {\n          // è§¦å‘ä¸€æ¬¡ mouseenter äº‹ä»¶ï¼Œè®© script.js å­˜å‚¨æ•°æ®\n          const event = new MouseEvent('mouseenter', { bubbles: true });\n          this.dispatchEvent(event);\n        }\n      });\n      // ç­‰å¾…äº‹ä»¶å¤„ç†å®Œæˆ\n      setTimeout(() => {\n        storeDataInAttributes(svgElement, type);\n        proceedWithNewWindow();\n      }, 100);\n      return;\n    } else if (type === 'heatmap') {\n      // çƒ­åŠ›å›¾éœ€è¦ç­‰å¾…æ•°æ®å­˜å‚¨å®Œæˆ\n      console.log('ğŸ” å¼€å§‹å­˜å‚¨çƒ­åŠ›å›¾æ•°æ®...');\n      storeDataInAttributes(svgElement, type);\n      // ç»™ä¸€ç‚¹æ—¶é—´ç¡®ä¿æ•°æ®å±æ€§è¢«è®¾ç½®\n      setTimeout(() => {\n        console.log('âœ… çƒ­åŠ›å›¾æ•°æ®å­˜å‚¨å®Œæˆï¼Œå‡†å¤‡æ‰“å¼€æ–°çª—å£');\n        proceedWithNewWindow();\n      }, 100);\n    } else {\n      storeDataInAttributes(svgElement, type);\n      proceedWithNewWindow();\n    }\n    \n    function proceedWithNewWindow() {\n\n      // å…‹éš† SVGï¼ˆæ·±æ‹·è´ï¼ŒåŒ…å«æ‰€æœ‰å­å…ƒç´ å’Œå±æ€§ï¼‰\n      const clonedSvg = svgElement.cloneNode(true);\n      \n      // ç¡®ä¿ SVG æœ‰æ­£ç¡®çš„å°ºå¯¸å’Œå‘½åç©ºé—´ï¼ˆé‡è¦ï¼šé˜²æ­¢è¢«è¯†åˆ«ä¸ºå›¾ç‰‡ï¼‰\n      const svgWidth = svgElement.getAttribute('width') || svgElement.clientWidth || 1200;\n      const svgHeight = svgElement.getAttribute('height') || svgElement.clientHeight || 800;\n      const viewBox = svgElement.getAttribute('viewBox');\n\n      // ç¡®ä¿ SVG æœ‰æ­£ç¡®çš„å‘½åç©ºé—´ï¼ˆé˜²æ­¢è¢«è¯†åˆ«ä¸ºå›¾ç‰‡ï¼‰\n      // é‡è¦ï¼šå¿…é¡»åœ¨å…‹éš†åç«‹å³è®¾ç½®ï¼Œå¦åˆ™å¯èƒ½è¢«æµè§ˆå™¨è¯†åˆ«ä¸ºå›¾ç‰‡\n      clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n      clonedSvg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');\n      \n      // ç§»é™¤å¯èƒ½è¢«è¯¯è¯†åˆ«ä¸ºå›¾ç‰‡çš„å±æ€§\n      clonedSvg.removeAttribute('content-type');\n      clonedSvg.removeAttribute('content');\n      clonedSvg.removeAttribute('type');\n\n      // è®¾ç½®å…‹éš† SVG çš„å°ºå¯¸\n      if (viewBox) {\n        clonedSvg.setAttribute('viewBox', viewBox);\n        clonedSvg.setAttribute('preserveAspectRatio', 'xMidYMid meet');\n      } else {\n        clonedSvg.setAttribute('width', svgWidth);\n        clonedSvg.setAttribute('height', svgHeight);\n      }\n      \n      // ç¡®ä¿ SVG å¯ä»¥æ¥æ”¶äº‹ä»¶ï¼ˆä¸æ˜¯å›¾ç‰‡ï¼‰\n      clonedSvg.style.pointerEvents = 'auto';\n      \n      // âœ… å¯¹äºçƒ­åŠ›å›¾ï¼Œç¡®ä¿æ‰€æœ‰å­å…ƒç´ ä¹Ÿå¯ä»¥æ¥æ”¶äº‹ä»¶\n      if (type === 'heatmap') {\n        const allElements = clonedSvg.querySelectorAll('*');\n        allElements.forEach(el => {\n          // ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å¯ä»¥æ¥æ”¶äº‹ä»¶\n          el.style.pointerEvents = 'auto';\n          // ç§»é™¤å¯èƒ½é˜»æ­¢äº‹ä»¶çš„æ ·å¼\n          if (el.style.pointerEvents === 'none') {\n            el.style.pointerEvents = 'auto';\n          }\n        });\n        console.log(`âœ… çƒ­åŠ›å›¾ï¼šå·²ä¸º ${allElements.length} ä¸ªå…ƒç´ è®¾ç½® pointer-events`);\n      }\n      \n      // âœ… ç§»é™¤å¯èƒ½è¢«è¯¯è¯†åˆ«ä¸ºå›¾ç‰‡çš„å±æ€§\n      clonedSvg.removeAttribute('role');\n      clonedSvg.removeAttribute('aria-label');\n      \n      // âœ… ä½¿ç”¨ XMLSerializer ç¡®ä¿ SVG æ­£ç¡®åºåˆ—åŒ–ï¼ˆä¿æŒå‘½åç©ºé—´ï¼‰\n      const serializer = new XMLSerializer();\n      const svgString = serializer.serializeToString(clonedSvg);\n\n      // åœ°å›¾å›¾ä¾‹åœ¨ä¸»é¡µé¢æ˜¯ç‹¬ç«‹çš„ #legendï¼ˆä¸åœ¨ SVG å†…ï¼‰ï¼Œæ–°çª—å£éœ€è¦é¢å¤–æ³¨å…¥\n      let mapLegendHTML = '';\n      if (type === 'map') {\n        const legendEl = document.getElementById('legend');\n        if (legendEl) mapLegendHTML = legendEl.innerHTML || '';\n      }\n\n      // âœ… çƒ­åŠ›å›¾å›¾ä¾‹åŒç†ï¼šä¸»é¡µé¢åœ¨ #heatmap-color-legendï¼ˆä¸åœ¨ SVG å†…ï¼‰\n      let heatmapLegendHTML = '';\n      if (type === 'heatmap') {\n        const legendEl = document.getElementById('heatmap-color-legend');\n        if (legendEl) heatmapLegendHTML = legendEl.innerHTML || '';\n      }\n\n      // æ–°çª—å£çš„ D3ï¼šä¼˜å…ˆç”¨ä¸»é¡µé¢å·²ç»åŠ è½½çš„æœ¬åœ° d3 è„šæœ¬ URLï¼ˆParcel å¾€å¾€ä¼šå¸¦ hashï¼‰\n      // è¿™æ ·å°±ç®—æ–°çª—å£ç¦ç”¨ opener æˆ–ç½‘ç»œæ‹¦æˆª CDNï¼Œäº¤äº’ä¹Ÿèƒ½æ­£å¸¸åˆå§‹åŒ–\n      let d3LocalUrl = '';\n      const d3LocalScript = document.querySelector('script[src*=\"d3-global\"]');\n      if (d3LocalScript && d3LocalScript.src) d3LocalUrl = d3LocalScript.src;\n\n      // åˆ›å»ºæ–°çª—å£çš„ HTMLï¼ŒåŒ…å«å¿…è¦çš„è„šæœ¬å’Œäº¤äº’åŠŸèƒ½\n      const html = createNewWindowHTML(svgString, title, type, mapLegendHTML, d3LocalUrl, heatmapLegendHTML);\n\n      // æ‰“å¼€æ–°çª—å£\n      const newWindow = window.open('', '_blank', 'width=1400,height=900,resizable=yes,scrollbars=yes');\n      if (newWindow) {\n        // âœ… ä½¿ç”¨æ›´ç°ä»£çš„æ–¹å¼å†™å…¥HTMLï¼Œé¿å…document.writeçš„è­¦å‘Š\n        newWindow.document.open('text/html', 'replace');\n        newWindow.document.write(html);\n        newWindow.document.close();\n        \n        // ç­‰å¾…DOMåŠ è½½å®Œæˆåï¼Œç¡®ä¿è„šæœ¬æ‰§è¡Œ\n        newWindow.addEventListener('load', function() {\n          console.log('âœ… æ–°çª—å£åŠ è½½å®Œæˆ');\n          // ç¡®ä¿åœ¨æ–°çª—å£ä¸­é‡æ–°åˆå§‹åŒ–äº¤äº’\n          if (type === 'heatmap') {\n            console.log('ğŸ”§ åœ¨æ–°çª—å£ä¸­é‡æ–°åˆå§‹åŒ–çƒ­åŠ›å›¾äº¤äº’...');\n            // è„šæœ¬å·²ç»åœ¨ HTML ä¸­ï¼Œè¿™é‡Œåªæ˜¯ç¡®è®¤\n          }\n        });\n      } else {\n        alert('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');\n      }\n    }\n  }\n\n  function storeDataInAttributes(svgElement, type) {\n    // å°† D3 æ•°æ®ç»‘å®šå­˜å‚¨åˆ° data-* å±æ€§ä¸­ï¼Œä»¥ä¾¿åœ¨æ–°çª—å£ä¸­æ¢å¤\n    try {\n      if (type === 'tree') {\n        // æ ‘å›¾ï¼šå­˜å‚¨èŠ‚ç‚¹æ•°æ®\n        const circles = d3.select(svgElement).selectAll('circle');\n        circles.each(function() {\n          const circle = d3.select(this);\n          const d = circle.datum();\n          \n          if (d && d.data) {\n            const data = d.data;\n            const scrapedInfo = data.scraped_info || {};\n            \n            // å­˜å‚¨å…³é”®ä¿¡æ¯åˆ° data å±æ€§\n            if (data.name) circle.attr('data-name', data.name);\n            if (scrapedInfo && Object.keys(scrapedInfo).length > 0) {\n              try {\n                circle.attr('data-scraped-info', JSON.stringify(scrapedInfo));\n              } catch(e) {\n                console.warn('æ— æ³•åºåˆ—åŒ– scraped_info:', e);\n              }\n            }\n            if (d.depth !== undefined) circle.attr('data-depth', d.depth);\n            if (d.children && d.children.length) {\n              circle.attr('data-children-count', d.children.length);\n            }\n            \n            // å­˜å‚¨ç¥–å…ˆä¿¡æ¯ï¼ˆé€šè¿‡éå†è·å–ï¼‰\n            try {\n              const ancestors = d.ancestors ? d.ancestors() : [];\n              if (ancestors.length > 1 && ancestors[1].data) {\n                circle.attr('data-category', ancestors[1].data.name || '');\n              }\n              if (ancestors.length > 2 && ancestors[2].data) {\n                circle.attr('data-subcategory', ancestors[2].data.name || '');\n              }\n            } catch(e) {\n              // å¦‚æœ ancestors ä¸å¯ç”¨ï¼Œè·³è¿‡\n            }\n          }\n        });\n      } else if (type === 'bubble') {\n        // æ°”æ³¡å›¾ï¼šå­˜å‚¨æ°”æ³¡æ•°æ®\n        const circles = d3.select(svgElement).selectAll('circle');\n        circles.each(function() {\n          const circle = d3.select(this);\n          const d = circle.datum();\n          \n          if (d && d.id) {\n            circle.attr('data-id', d.id);\n            if (d.total_plays !== undefined) circle.attr('data-plays', d.total_plays);\n            if (d.total_comments !== undefined) circle.attr('data-comments', d.total_comments);\n            if (d.rate !== undefined) circle.attr('data-rate', d.rate);\n            if (d.influence !== undefined && d.influence !== null) circle.attr('data-influence', d.influence);\n          }\n        });\n      } else if (type === 'map') {\n        // åœ°å›¾ï¼šå›½å®¶æ•°æ®ï¼ˆscript.js å·²ç»åœ¨ mouseenter æ—¶å­˜å‚¨äº†æ•°æ®ï¼‰\n        // è¿™é‡Œåªéœ€è¦ç¡®ä¿æ‰€æœ‰ path éƒ½æœ‰å›½å®¶åç§°\n        const paths = d3.select(svgElement).selectAll('.country, path');\n        paths.each(function() {\n          const path = d3.select(this);\n          const d = path.datum();\n          \n          if (d && d.properties) {\n            const name = d.properties.name;\n            if (name && !path.attr('data-country-name')) {\n              path.attr('data-country-name', name);\n            }\n          }\n        });\n      } else if (type === 'heatmap') {\n        // çƒ­åŠ›å›¾ï¼šå­˜å‚¨å•å…ƒæ ¼æ•°æ®ï¼ˆ3Då’Œ2Déƒ½æ”¯æŒï¼‰\n        console.log('ğŸ” å¼€å§‹å­˜å‚¨çƒ­åŠ›å›¾æ•°æ®...');\n        \n        // 3Dçƒ­åŠ›å›¾ï¼šç«‹æ–¹ä½“ç»„ï¼ˆg.cell-groupï¼‰\n        const cellGroups = d3.select(svgElement).selectAll('g[class*=\"cell-group\"]');\n        let storedCount = 0;\n        \n        cellGroups.each(function() {\n          const group = d3.select(this);\n          const d = group.datum();\n          \n          // å°è¯•ä»datumè·å–æ•°æ®ï¼Œå¦‚æœå¤±è´¥åˆ™ä»classåè§£æ\n          let genre, month, value, genreIdx, monthIdx;\n          \n          if (d && d.genre && d.month) {\n            // ä»datumè·å–\n            genre = d.genre;\n            month = d.month;\n            value = d.value !== undefined ? d.value : 0;\n            genreIdx = d.genreIdx;\n            monthIdx = d.monthIdx;\n          } else {\n            // ä»classåè§£æï¼šcell-group cell-{monthIdx}-{genreIdx}\n            const classAttr = group.attr('class') || '';\n            const match = classAttr.match(/cell-(\\d+)-(\\d+)/);\n            if (match) {\n              monthIdx = parseInt(match[1]);\n              genreIdx = parseInt(match[2]);\n              \n              // å®šä¹‰æœˆä»½å’Œé£æ ¼æ•°ç»„ï¼ˆä¸heatmap.jsä¿æŒä¸€è‡´ï¼‰\n              const months = ['2023-12', '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',\n                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',\n                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06',\n                '2025-07', '2025-08', '2025-09', '2025-10', '2025-11', '2025-12'];\n              const allGenres = [\"ACG\", \"classical\", \"electronic\", \"folk\", \"jazz\", \"pop\", \"rap\", \"rock\"];\n              \n              // ä»æ•°ç»„è·å–genreå’Œmonth\n              if (monthIdx >= 0 && monthIdx < months.length) month = months[monthIdx];\n              if (genreIdx >= 0 && genreIdx < allGenres.length) genre = allGenres[genreIdx];\n              \n              // å°è¯•ä»datumè·å–valueï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¾ä¸º0\n              value = (d && d.value !== undefined) ? d.value : 0;\n            }\n          }\n          \n          // å¦‚æœä»ç„¶æ²¡æœ‰æ•°æ®ï¼Œè·³è¿‡\n          if (!genre || !month) {\n            return;\n          }\n          \n          // å­˜å‚¨åˆ°groupå’Œæ‰€æœ‰å­å…ƒç´ ä¸Š\n          group.attr('data-genre', genre);\n          group.attr('data-month', month);\n          group.attr('data-value', value);\n          if (genreIdx !== undefined) group.attr('data-genre-idx', genreIdx);\n          if (monthIdx !== undefined) group.attr('data-month-idx', monthIdx);\n          \n          // ä¸ºgroupå†…çš„æ‰€æœ‰pathå…ƒç´ å­˜å‚¨æ•°æ®ï¼ˆç‰¹åˆ«æ˜¯é¡¶é¢ï¼‰\n          group.selectAll('path').each(function() {\n            const path = d3.select(this);\n            path.attr('data-genre', genre);\n            path.attr('data-month', month);\n            path.attr('data-value', value);\n            // å­˜å‚¨æ›²ç›®æ•°é‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œä½¿ç”¨ value çš„æ•´æ•°éƒ¨åˆ†ä½œä¸ºåå¤‡ï¼‰\n            const trackCount = Math.round(value);\n            path.attr('data-track-count', trackCount);\n          });\n          \n          storedCount++;\n        });\n        \n        console.log(`âœ… 3Dçƒ­åŠ›å›¾ï¼šå­˜å‚¨äº† ${storedCount} ä¸ªå•å…ƒæ ¼ç»„çš„æ•°æ®`);\n        \n        // 2Dçƒ­åŠ›å›¾ï¼šçŸ©å½¢å•å…ƒæ ¼ï¼ˆrect.cellï¼‰\n        const cells = d3.select(svgElement).selectAll('rect.cell');\n        let cellCount = 0;\n        \n        cells.each(function() {\n          const cell = d3.select(this);\n          const d = cell.datum();\n          \n          if (d && d.genre && d.month) {\n            cell.attr('data-genre', d.genre);\n            cell.attr('data-month', d.month);\n            if (d.value !== undefined) cell.attr('data-value', d.value);\n            cellCount++;\n          }\n        });\n        \n        console.log(`âœ… 2Dçƒ­åŠ›å›¾ï¼šå­˜å‚¨äº† ${cellCount} ä¸ªå•å…ƒæ ¼çš„æ•°æ®`);\n        \n        // âœ… æŠ˜çº¿å›¾ï¼šå­˜å‚¨æŠ˜çº¿æ•°æ®ï¼ˆline-path å’Œ area-pathï¼‰\n        const linePaths = d3.select(svgElement).selectAll('path.line-path, path.area-path');\n        let lineCount = 0;\n        \n        linePaths.each(function() {\n          try {\n            const path = d3.select(this);\n            const d = path.datum();\n            \n            if (d && d.month) {\n              // å­˜å‚¨æœˆä»½ä¿¡æ¯\n              path.attr('data-month', d.month);\n              if (d.monthIdx !== undefined) {\n                path.attr('data-month-idx', d.monthIdx);\n              }\n              \n              // å¦‚æœæœ‰ lineDataï¼Œå­˜å‚¨æ•°æ®ç‚¹çš„å€¼ï¼ˆç”¨äº tooltipï¼‰\n              if (d.lineData && Array.isArray(d.lineData) && d.lineData.length > 0) {\n                const allGenres = [\"ACG\", \"classical\", \"electronic\", \"folk\", \"jazz\", \"pop\", \"rap\", \"rock\"];\n                \n                // å­˜å‚¨æ‰€æœ‰æ•°æ®ç‚¹çš„å€¼ï¼ˆJSONæ ¼å¼ï¼‰\n                try {\n                  const values = d.lineData.map((p, idx) => {\n                    if (p && typeof p === 'object') {\n                      return {\n                        genre: allGenres[idx] || `Genre${idx}`,\n                        value: p.value || 0\n                      };\n                    }\n                    return {\n                      genre: allGenres[idx] || `Genre${idx}`,\n                      value: 0\n                    };\n                  }).filter(v => v !== null);\n                  \n                  if (values.length > 0) {\n                    path.attr('data-line-values', JSON.stringify(values));\n                  }\n                } catch(e) {\n                  console.warn('æ— æ³•åºåˆ—åŒ–æŠ˜çº¿æ•°æ®:', e);\n                }\n              }\n              \n              lineCount++;\n            }\n          } catch(e) {\n            console.warn('å¤„ç†æŠ˜çº¿è·¯å¾„æ—¶å‡ºé”™:', e);\n          }\n        });\n        \n        console.log(`âœ… æŠ˜çº¿å›¾ï¼šå­˜å‚¨äº† ${lineCount} æ¡æŠ˜çº¿çš„æ•°æ®`);\n        \n        // å¦‚æœå­˜å‚¨çš„æ•°æ®å¾ˆå°‘ï¼Œå°è¯•ç›´æ¥ä»åŸå§‹çƒ­åŠ›å›¾æ•°æ®ä¸­æ¢å¤\n        if (storedCount === 0 && cellCount === 0) {\n          console.warn('âš ï¸ æœªæ‰¾åˆ°çƒ­åŠ›å›¾æ•°æ®ï¼Œå°è¯•ä»SVGç»“æ„æ¨æ–­...');\n          // è¿™é‡Œå¯ä»¥æ·»åŠ å¤‡ç”¨é€»è¾‘ï¼Œæ¯”å¦‚ä»åæ ‡ä½ç½®æ¨æ–­genreå’Œmonth\n        }\n      }\n    } catch(e) {\n      console.warn('å­˜å‚¨æ•°æ®åˆ°å±æ€§æ—¶å‡ºé”™:', e);\n    }\n  }\n\n  // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–å›½å®¶åç§°ï¼ˆä¸ script.js ä¸­çš„ normalize å‡½æ•°ä¿æŒä¸€è‡´ï¼‰\n  function normalizeCountryName(name) {\n    if (!name) return name;\n    const ALIASES = new Map([\n      [\"United States of America\", \"United States\"],\n      [\"Russian Federation\", \"Russia\"],\n      [\"Czech Republic\", \"Czechia\"],\n      [\"Korea, Republic of\", \"South Korea\"],\n      [\"Korea, Democratic People's Republic of\", \"North Korea\"],\n      [\"Syrian Arab Republic\", \"Syria\"],\n      [\"Lao People's Democratic Republic\", \"Laos\"],\n      [\"Viet Nam\", \"Vietnam\"],\n      [\"Eswatini\", \"Eswatini\"],\n      [\"Swaziland\", \"Eswatini\"],\n      [\"Cabo Verde\", \"Cape Verde\"],\n      [\"Myanmar\", \"Myanmar (Burma)\"],\n      [\"Macedonia\", \"North Macedonia\"],\n      [\"Taiwan, Province of China\", \"Taiwan\"]\n    ]);\n    const trimmed = name.trim();\n    return ALIASES.get(trimmed) || trimmed;\n  }\n\n  //#region æ–°çª—å£å¤§å›¾æ¨¡æ¿ï¼ˆSVG å¤åˆ¶ + äº¤äº’æ¢å¤ + çƒ­åŠ›å›¾æ³¨é‡Š/å›¾ä¾‹ï¼‰\n  function createNewWindowHTML(svgString, title, type, mapLegendHTML = '', d3LocalUrl = '', heatmapLegendHTML = '') {\n    // æ ¹æ®ç±»å‹ç”Ÿæˆä¸åŒçš„äº¤äº’è„šæœ¬\n    let interactionScript = '';\n    \n    // âœ… ç”Ÿæˆçƒ­åŠ›å›¾åˆå§‹åŒ–ä»£ç å­—ç¬¦ä¸²ï¼ˆåœ¨å‡½æ•°ä½œç”¨åŸŸä¸­ç”Ÿæˆï¼Œé¿å…æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„æ¡ä»¶åˆ¤æ–­é—®é¢˜ï¼‰\n    const heatmapInitCode = type === 'heatmap' ? `\n      console.log('ğŸ”¥ğŸ”¥ğŸ”¥ çƒ­åŠ›å›¾åˆå§‹åŒ–ä»£ç å·²æ‰§è¡Œï¼');\n      console.log('ğŸ”¥ å¼€å§‹åˆå§‹åŒ–çƒ­åŠ›å›¾äº¤äº’...');\n      const svg = document.querySelector('#svg-container-main svg') || document.querySelector('svg');\n      if (!svg) {\n        console.warn('âš ï¸ æœªæ‰¾åˆ° SVGï¼Œæ— æ³•åˆå§‹åŒ–çƒ­åŠ›å›¾äº¤äº’');\n        return;\n      }\n      const svgD3 = d3.select(svg);\n      const tooltip = d3.select(\"body\").append(\"div\")\n        .attr(\"class\", \"heatmap-tooltip\")\n        .style(\"position\", \"fixed\")\n        .style(\"pointer-events\", \"none\")\n        .style(\"opacity\", 0)\n        .style(\"padding\", \"10px 12px\")\n        .style(\"border-radius\", \"12px\")\n        .style(\"background\", \"rgba(30, 41, 59, 0.92)\")\n        .style(\"color\", \"#fff\")\n        .style(\"font\", \"13px/1.35 system-ui, -apple-system, Segoe UI, Microsoft YaHei, sans-serif\")\n        .style(\"box-shadow\", \"0 10px 24px rgba(0,0,0,0.16)\")\n        .style(\"z-index\", 10000)\n        .style(\"backdrop-filter\", \"blur(6px)\")\n        .style(\"border\", \"1px solid rgba(88, 101, 242, 0.5)\");\n      \n      // ä¸ºæ‰€æœ‰ path å…ƒç´ ç»‘å®šäº‹ä»¶ï¼ˆ3Dçƒ­åŠ›å›¾ï¼‰\n      const cellGroupPaths = svgD3.selectAll('g[class*=\"cell-group\"] path');\n      console.log('ğŸ” æ‰¾åˆ° ' + cellGroupPaths.size() + ' ä¸ª cell-group path å…ƒç´ ');\n      \n      cellGroupPaths.each(function() {\n        const path = d3.select(this);\n        const genre = path.attr('data-genre') || path.node().parentElement?.getAttribute('data-genre');\n        const month = path.attr('data-month') || path.node().parentElement?.getAttribute('data-month');\n        const value = path.attr('data-value') || path.node().parentElement?.getAttribute('data-value') || '0';\n        \n        if (genre && month) {\n          const pathNode = path.node();\n          pathNode.style.pointerEvents = 'auto';\n          pathNode.style.cursor = 'pointer';\n          \n          path\n            .on(\"mouseover\", function(event) {\n              d3.select(this.parentNode).selectAll(\"path\")\n                .attr(\"opacity\", 1)\n                .attr(\"stroke-width\", 1.5);\n              \n              tooltip\n                .style(\"opacity\", 0.95)\n                .html('<b>' + genre + '</b><br/>' + month + '<br/>åˆ†å€¼: ' + parseFloat(value).toFixed(2))\n                .style(\"left\", (event.pageX + 12) + \"px\")\n                .style(\"top\", (event.pageY - 18) + \"px\");\n            })\n            .on(\"mouseout\", function() {\n              d3.select(this.parentNode).selectAll(\"path\")\n                .attr(\"opacity\", 0.9)\n                .attr(\"stroke-width\", 0.5);\n              tooltip.style(\"opacity\", 0);\n            });\n        }\n      });\n      \n      // ä¸ºæ‰€æœ‰ rect.cell ç»‘å®šäº‹ä»¶ï¼ˆ2Dçƒ­åŠ›å›¾ï¼‰\n      const cells = svgD3.selectAll('rect.cell');\n      console.log('ğŸ” æ‰¾åˆ° ' + cells.size() + ' ä¸ª rect.cell å…ƒç´ ');\n      \n      cells.each(function() {\n        const cell = d3.select(this);\n        const genre = cell.attr('data-genre');\n        const month = cell.attr('data-month');\n        const value = cell.attr('data-value');\n        \n        if (genre && month) {\n          const cellNode = cell.node();\n          cellNode.style.pointerEvents = 'auto';\n          cellNode.style.cursor = 'pointer';\n          \n          cell\n            .on(\"mousemove\", function(event) {\n              tooltip\n                .style(\"opacity\", 1)\n                .html('<b>' + genre + '</b><br/>' + month + '<br/>Value: ' + value)\n                .style(\"left\", (event.pageX + 12) + \"px\")\n                .style(\"top\", (event.pageY - 18) + \"px\");\n            })\n            .on(\"mouseout\", function() {\n              tooltip.style(\"opacity\", 0);\n            });\n        }\n      });\n      \n      // æ·»åŠ ç¼©æ”¾åŠŸèƒ½\n      const g = svgD3.select('g');\n      if (!g.empty()) {\n        const zoom = d3.zoom()\n          .scaleExtent([0.5, 3])\n          .on(\"zoom\", (event) => {\n            g.attr(\"transform\", event.transform);\n          });\n        svgD3.call(zoom);\n        console.log('âœ… ç¼©æ”¾åŠŸèƒ½å·²å¯ç”¨');\n      }\n      \n      console.log('âœ… çƒ­åŠ›å›¾äº¤äº’åˆå§‹åŒ–å®Œæˆ');\n    ` : '';\n    \n    if (type === 'tree') {\n      // æ ‘å›¾çš„ç¼©æ”¾å’Œæ‹–æ‹½åŠŸèƒ½\n      interactionScript = `\n        <script>\n          (function() {\n            if (typeof d3 === 'undefined') return;\n            const svg = d3.select('svg');\n            const g = svg.select('g');\n            \n            if (g.empty()) return;\n            \n            // åˆ›å»º tooltip\n            let tooltip = d3.select(\"body\").select(\".tree-tooltip\");\n            if (tooltip.empty()) {\n              tooltip = d3.select(\"body\")\n                .append(\"div\")\n                .attr(\"class\", \"tree-tooltip\")\n                .style(\"position\", \"absolute\")\n                .style(\"pointer-events\", \"none\")\n                .style(\"padding\", \"12px 14px\")\n                .style(\"border-radius\", \"12px\")\n                .style(\"background\", \"rgba(15, 23, 42, 0.95)\")\n                .style(\"color\", \"#e2e8f0\")\n                .style(\"font\", \"13px/1.4 system-ui, -apple-system, Segoe UI, Microsoft YaHei, sans-serif\")\n                .style(\"opacity\", 0)\n                .style(\"backdrop-filter\", \"blur(6px)\")\n                .style(\"z-index\", 1000)\n                .style(\"border\", \"1px solid rgba(88, 101, 242, 0.5)\");\n            }\n            \n            // ç¼©æ”¾å’Œæ‹–æ‹½åŠŸèƒ½\n            const zoom = d3.zoom()\n              .scaleExtent([0.45, 7])\n              .on(\"start\", () => svg.style(\"cursor\", \"grabbing\"))\n              .on(\"end\", () => svg.style(\"cursor\", \"grab\"))\n              .on(\"zoom\", (event) => {\n                g.attr(\"transform\", event.transform);\n              });\n            \n            svg.call(zoom);\n            svg.call(zoom.transform, d3.zoomIdentity.scale(0.95));\n            \n            // é‡æ–°ç»‘å®š tooltip äº‹ä»¶ï¼ˆä» data å±æ€§è¯»å–æ•°æ®ï¼‰\n            svg.selectAll('circle').each(function() {\n              const circle = d3.select(this);\n              const name = circle.attr('data-name');\n              const depth = parseInt(circle.attr('data-depth') || '0');\n              const category = circle.attr('data-category') || '';\n              const subcategory = circle.attr('data-subcategory') || '';\n              const scrapedInfoStr = circle.attr('data-scraped-info');\n              const childrenCount = circle.attr('data-children-count');\n              \n              if (!name) return;\n              \n              let scrapedInfo = {};\n              if (scrapedInfoStr) {\n                try {\n                  scrapedInfo = JSON.parse(scrapedInfoStr);\n                } catch(e) {}\n              }\n              \n              const location = scrapedInfo.location || null;\n              const years = scrapedInfo.years || [];\n              const culturalOrigins = scrapedInfo.cultural_origins || null;\n              const stylisticOrigins = scrapedInfo.stylistic_origins || null;\n              \n              circle\n                .on(\"mouseenter\", function(event) {\n                  let html = '<div style=\"font-weight:800;margin-bottom:6px;letter-spacing:.3px\">' + name + '</div>';\n                  \n                  if (depth === 1) {\n                    html += '<div style=\"opacity:.92\">ç±»åˆ«ï¼š' + category + '</div>';\n                  } else if (depth === 2) {\n                    html += '<div style=\"opacity:.92\">ç±»åˆ«ï¼š' + category + '</div>';\n                    html += '<div style=\"opacity:.92\">å­ç±»åˆ«ï¼š' + subcategory + '</div>';\n                  } else if (depth >= 3) {\n                    html += '<div style=\"opacity:.92\">ç±»åˆ«ï¼š' + category + '</div>';\n                    if (subcategory) {\n                      html += '<div style=\"opacity:.92\">å­ç±»åˆ«ï¼š' + subcategory + '</div>';\n                    }\n                    html += '<div style=\"opacity:.92\">æµæ´¾ï¼š' + name + '</div>';\n                  }\n                  \n                  if (years && years.length > 0) {\n                    const yearStr = years.length === 1 ? years[0] : \n                                   years.length === 2 ? years[0] + ' - ' + years[1] : \n                                   years[0] + ' - ' + years[years.length - 1];\n                    html += '<div style=\"opacity:.92;margin-top:6px\">æ—¶é—´ï¼š' + yearStr + '</div>';\n                  } else if (culturalOrigins) {\n                    const yearMatch = culturalOrigins.match(/\\\\b(1[0-9]{3}|20[0-2][0-9])\\\\b/);\n                    if (yearMatch) {\n                      html += '<div style=\"opacity:.92;margin-top:6px\">æ—¶é—´ï¼š' + culturalOrigins + '</div>';\n                    }\n                  }\n                  \n                  if (location) {\n                    html += '<div style=\"opacity:.92\">åœ°ç‚¹ï¼š' + location + '</div>';\n                  }\n                  \n                  if (culturalOrigins && !years.length) {\n                    html += '<div style=\"opacity:.92\">æ–‡åŒ–èµ·æºï¼š' + culturalOrigins + '</div>';\n                  }\n                  \n                  if (stylisticOrigins) {\n                    html += '<div style=\"opacity:.92\">é£æ ¼èµ·æºï¼š' + stylisticOrigins + '</div>';\n                  }\n                  \n                  if (childrenCount && parseInt(childrenCount) > 0) {\n                    html += '<div style=\"opacity:.70;margin-top:6px\">å­èŠ‚ç‚¹æ•°ï¼š' + childrenCount + '</div>';\n                  }\n                  \n                  tooltip.style(\"opacity\", 1).html(html);\n                })\n                .on(\"mousemove\", function(event) {\n                  tooltip\n                    .style(\"left\", (event.pageX + 14) + \"px\")\n                    .style(\"top\", (event.pageY + 14) + \"px\");\n                })\n                .on(\"mouseleave\", function() {\n                  tooltip.style(\"opacity\", 0);\n                });\n            });\n          })();\n        </script>\n      `;\n    } else if (type === 'bubble') {\n      // æ°”æ³¡å›¾çš„ tooltip åŠŸèƒ½\n      interactionScript = `\n        <script>\n          (function() {\n            if (typeof d3 === 'undefined') return;\n            let tooltip = d3.select(\"body\").select(\".bubble-tooltip\");\n            if (tooltip.empty()) {\n              tooltip = d3.select(\"body\").append(\"div\")\n                .attr(\"class\", \"bubble-tooltip\")\n                .style(\"position\", \"absolute\")\n                .style(\"pointer-events\", \"none\")\n                .style(\"padding\", \"12px 14px\")\n                .style(\"border-radius\", \"12px\")\n                .style(\"background\", \"rgba(15, 23, 42, 0.95)\")\n                .style(\"color\", \"#e2e8f0\")\n                .style(\"font\", \"13px/1.4 system-ui, -apple-system, Segoe UI, Microsoft YaHei, sans-serif\")\n                .style(\"opacity\", 0)\n                .style(\"backdrop-filter\", \"blur(6px)\")\n                .style(\"z-index\", 1000)\n                .style(\"border\", \"1px solid rgba(88, 101, 242, 0.5)\");\n            }\n            \n            function formatBig(n) {\n              return n ? n.toLocaleString() : '0';\n            }\n            function pct(x) {\n              return x ? (x * 100).toFixed(2) + '%' : '0%';\n            }\n            \n            d3.select('svg').selectAll('circle').each(function() {\n              const circle = d3.select(this);\n              const id = circle.attr('data-id');\n              const plays = circle.attr('data-plays');\n              const comments = circle.attr('data-comments');\n              const rate = circle.attr('data-rate');\n              const influence = circle.attr('data-influence');\n              \n              if (!id) return;\n              \n              circle\n                .on(\"mouseenter\", function(event) {\n                  const inf = (influence !== null && influence !== undefined && influence !== '') ? Number(influence) : NaN;\n                  const infText = Number.isFinite(inf) ? inf.toFixed(4) : 'N/A';\n                  const html = '<div style=\"font-weight:800;margin-bottom:6px;letter-spacing:.3px\">' + id + '</div>' +\n                               '<div style=\"opacity:.92\">Playsï¼š' + formatBig(plays) + '</div>' +\n                               '<div style=\"opacity:.92\">Commentsï¼š' + formatBig(comments) + '</div>' +\n                               '<div style=\"opacity:.92;margin-top:6px\">Influenceï¼š' + infText + '</div>' +\n                               (rate ? '<div style=\"opacity:.92;margin-top:6px\">äº’åŠ¨ç‡ï¼š' + pct(rate) + '</div>' : '') +\n                               '<div style=\"opacity:.70;margin-top:6px\">æ°”æ³¡=å½±å“åŠ›(influence)ï½œå¤–ç¯=äº’åŠ¨ç‡ï¼ˆç›¸å¯¹è¿›åº¦ï¼‰</div>';\n                  \n                  tooltip.style(\"opacity\", 1).html(html);\n                })\n                .on(\"mousemove\", function(event) {\n                  tooltip\n                    .style(\"left\", (event.pageX + 14) + \"px\")\n                    .style(\"top\", (event.pageY + 14) + \"px\");\n                })\n                .on(\"mouseleave\", function() {\n                  tooltip.style(\"opacity\", 0);\n                });\n            });\n          })();\n        </script>\n      `;\n    } else if (type === 'map') {\n      // åœ°å›¾çš„ tooltip åŠŸèƒ½\n      interactionScript = `\n        <script>\n          (function() {\n            if (typeof d3 === 'undefined') return;\n            let tooltip = d3.select(\"body\").select(\".map-tooltip\");\n            if (tooltip.empty()) {\n              tooltip = d3.select(\"body\").append(\"div\")\n                .attr(\"class\", \"map-tooltip\")\n                .style(\"position\", \"absolute\")\n                .style(\"pointer-events\", \"none\")\n                .style(\"padding\", \"12px 14px\")\n                .style(\"border-radius\", \"12px\")\n                .style(\"background\", \"rgba(15, 23, 42, 0.95)\")\n                .style(\"color\", \"#e2e8f0\")\n                .style(\"font\", \"13px/1.4 system-ui, -apple-system, Segoe UI, Microsoft YaHei, sans-serif\")\n                .style(\"opacity\", 0)\n                .style(\"backdrop-filter\", \"blur(6px)\")\n                .style(\"z-index\", 1000)\n                .style(\"border\", \"1px solid rgba(88, 101, 242, 0.5)\");\n            }\n            \n            // ä¸ºæ‰€æœ‰è·¯å¾„å…ƒç´ ç»‘å®šäº‹ä»¶ï¼ˆåŒ…æ‹¬ .country å’Œæ™®é€š pathï¼‰\n            d3.select('svg').selectAll('path').each(function() {\n              const path = d3.select(this);\n              const countryName = path.attr('data-country-name');\n              const genre = path.attr('data-genre');\n              const value = path.attr('data-value');\n              const d = path.datum();\n              \n              // ä» data å±æ€§æˆ– datum è·å–å›½å®¶åç§°\n              let name = countryName;\n              if (!name && d && d.properties) {\n                name = d.properties.name;\n              }\n              \n              if (name) {\n                path\n                  .on(\"mouseenter\", function(event) {\n                    let html = '<div style=\"font-weight:800;margin-bottom:6px;letter-spacing:.3px\">' + name + '</div>';\n                    if (genre && value) {\n                      html += '<div style=\"opacity:.92\">ğŸµ ' + genre + '</div>';\n                      html += '<div style=\"opacity:.92;margin-top:6px\">ğŸ“Š åˆ†æ•°: ' + value + '</div>';\n                    } else {\n                      html += '<div style=\"opacity:.92\">æš‚æ— æ•°æ®</div>';\n                    }\n                    tooltip.style(\"opacity\", 1).html(html);\n                  })\n                  .on(\"mousemove\", function(event) {\n                    tooltip\n                      .style(\"left\", (event.pageX + 14) + \"px\")\n                      .style(\"top\", (event.pageY + 14) + \"px\");\n                  })\n                  .on(\"mouseleave\", function() {\n                    tooltip.style(\"opacity\", 0);\n                  });\n              }\n            });\n          })();\n        </script>\n      `;\n    } else if (type === 'heatmap') {\n      // çƒ­åŠ›å›¾ï¼šäº¤äº’ç»Ÿä¸€ç”±ä¸»è„šæœ¬ä¸­çš„ initHeatmapInteractions å¤„ç†ï¼ˆé¿å…é‡å¤ç»‘å®š/zoom æŠ¢äº‹ä»¶ï¼‰\n      interactionScript = '';\n    }\n\n    // âœ… è°ƒè¯•ï¼šç¡®è®¤çƒ­åŠ›å›¾ä»£ç æ˜¯å¦ç”Ÿæˆ\n    console.log('ğŸ“ [createNewWindowHTML] å›¾è¡¨ç±»å‹:', type);\n    if (type === 'heatmap') {\n      console.log('ğŸ“ [createNewWindowHTML] çƒ­åŠ›å›¾ç±»å‹æ£€æµ‹:', type);\n      console.log('ğŸ“ [createNewWindowHTML] heatmapInitCode é•¿åº¦:', heatmapInitCode ? heatmapInitCode.length : 0);\n      console.log('ğŸ“ [createNewWindowHTML] heatmapInitCode æ˜¯å¦ä¸ºç©º:', !heatmapInitCode || heatmapInitCode.length === 0);\n    }\n\n    return `\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${title} - è¯¦ç»†è§†å›¾</title>\n  <style>\n    * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n    }\n    :root{\n      /* æ–°çª—å£èƒŒæ™¯ï¼šæ¯”ä¸»é¡µé¢æ›´æµ…ä¸€æ¡£ï¼Œé¿å…â€œå¤ªé»‘â€ */\n      --bg: #0b0624;\n      --bg-0: #0b0624;\n      --bg-1: #140a35;\n      --bg-2: #1c0c44;\n      --bg-3: #0b1230;\n      --text: #e2e8f0;\n      --muted: #94a3b8;\n      --accent-violet: #7c3aed;\n      --accent-pink: #ff3bd4;\n      --accent-blue: #32a7ff;\n    }\n    html, body {\n      width: 100%;\n      height: 100%;\n      overflow: hidden;\n      background:\n        radial-gradient(circle at 18% 28%, rgba(255, 59, 212, 0.12) 0%, transparent 54%),\n        radial-gradient(circle at 82% 68%, rgba(50, 167, 255, 0.11) 0%, transparent 56%),\n        linear-gradient(135deg, var(--bg-0) 0%, var(--bg-1) 28%, var(--bg-2) 58%, var(--bg-3) 100%);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n    .svg-container {\n      width: 100%;\n      height: 100%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 20px;\n    }\n    /* åœ°å›¾å›¾ä¾‹ï¼šæ–°çª—å£å›ºå®šåœ¨å·¦ä¸‹è§’ */\n    .map-legend{\n      position: fixed;\n      left: 20px;\n      bottom: 20px;\n      display: flex;\n      flex-wrap: wrap;\n      gap: 10px 12px;\n      max-width: min(680px, 72vw);\n      padding: 12px 14px;\n      border-radius: 10px;\n      background: rgba(18, 8, 42, 0.86);\n      border: 1px solid rgba(50, 167, 255, 0.28);\n      color: var(--text);\n      backdrop-filter: blur(10px);\n      box-shadow: 0 0 18px rgba(255, 59, 212, 0.16), 0 0 24px rgba(50, 167, 255, 0.12);\n      z-index: 1200;\n      pointer-events: none; /* ä¸æŒ¡ä½åœ°å›¾ hover äº¤äº’ */\n    }\n    /* çƒ­åŠ›å›¾å›¾ä¾‹ï¼šæ–°çª—å£å›ºå®šåœ¨åº•éƒ¨ï¼ˆä¸ä¸»é¡µé¢ä¸€è‡´ï¼šçº¿æ€§æ¸å˜æ¡ + ä¸¤ç«¯æ•°å€¼ï¼‰ */\n    .heatmap-legend{\n      position: fixed;\n      left: 50%;\n      transform: translateX(-50%);\n      bottom: 20px;\n      width: min(520px, 76vw);\n      padding: 10px 12px;\n      border-radius: 12px;\n      background: rgba(18, 8, 42, 0.70);\n      border: 1px solid rgba(50, 167, 255, 0.26);\n      box-shadow: 0 0 18px rgba(255, 59, 212, 0.12), 0 0 24px rgba(50, 167, 255, 0.10);\n      color: rgba(226, 232, 240, 0.88);\n      backdrop-filter: blur(10px);\n      z-index: 1200;\n      pointer-events: none; /* ä¸æŒ¡ä½çƒ­åŠ›å›¾ hover */\n    }\n    /* çƒ­åŠ›å›¾ï¼šåªä¿ç•™åŸå›¾æ³¨é‡Šï¼ˆä¸é¢å¤–åŠ  3D/2D å¾½æ ‡ï¼Œé¿å…â€œå¥—å¨ƒâ€ï¼‰ */\n    .hm-anno{\n      position: fixed;\n      left: 20px;\n      top: 20px; /* âœ… æ–°çª—å£ä¹Ÿæ”¹ä¸ºã€å·¦ä¸Šè§’ã€‘ï¼Œä¿æŒä¸€è‡´ï¼Œä¸”é¿å¼€åº•éƒ¨å›¾ä¾‹ */\n      width: min(340px, 46vw);\n      border-radius: 12px;\n      background: rgba(10, 5, 20, 0.85); /* æ›´é»‘çš„èƒŒæ™¯ */\n      border: 1px solid rgba(124, 58, 237, 0.3);\n      box-shadow: 0 4px 16px rgba(0,0,0,0.4);\n      color: rgba(226,232,240,0.9);\n      backdrop-filter: blur(8px);\n      z-index: 1200;\n      overflow: hidden;\n      pointer-events: auto; /* å…è®¸æŠ˜å /å±•å¼€ */\n    }\n    .hm-anno > summary{\n      list-style: none;\n      cursor: pointer;\n      padding: 10px 12px;\n      font: 13px/1.1 system-ui,-apple-system,\"Segoe UI\",\"Microsoft YaHei\",sans-serif;\n      font-weight: 700;\n      letter-spacing: .5px;\n      user-select: none;\n      color: #fff;\n    }\n    .hm-anno > summary::-webkit-details-marker{ display:none; }\n    .hm-anno .hm-anno-body{\n      padding: 0 12px 12px 12px;\n      font: 12px/1.6 system-ui,-apple-system,\"Segoe UI\",\"Microsoft YaHei\",sans-serif;\n      color: rgba(226,232,240,0.85);\n    }\n    .hm-anno .hm-anno-body div {\n      margin-bottom: 2px;\n    }\n    .hm-anno .hm-anno-body b{\n      color: rgba(226,232,240,0.92);\n      font-weight: 700;\n    }\n    .map-legend .legend-item{\n      display:flex;\n      align-items:center;\n      gap:8px;\n      white-space:nowrap;\n      font-size:12px;\n      color: var(--text);\n    }\n    .map-legend .legend-color{\n      width:14px;\n      height:14px;\n      border-radius:3px;\n      border:1px solid rgba(255,255,255,0.2);\n      box-shadow: 0 0 4px rgba(0,0,0,0.35);\n      display:inline-block;\n    }\n    .map-legend .legend-text{\n      color: var(--text);\n      font-weight: 500;\n      text-shadow: 0 1px 2px rgba(0,0,0,0.5);\n    }\n    svg {\n      max-width: 100%;\n      max-height: 100%;\n      background: transparent;\n    }\n    .close-btn {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: rgba(18, 8, 42, 0.82);\n      color: var(--text);\n      border: 1px solid rgba(50, 167, 255, 0.32);\n      padding: 8px 16px;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 14px;\n      z-index: 1000;\n      transition: all 0.3s ease;\n    }\n    .close-btn:hover {\n      background: rgba(255, 59, 212, 0.14);\n      border-color: rgba(255, 59, 212, 0.42);\n    }\n    .title {\n      position: fixed;\n      top: 20px;\n      left: 20px;\n      color: var(--text);\n      font-size: 18px;\n      font-weight: 600;\n      z-index: 1000;\n      text-shadow: 0 0 12px rgba(255, 59, 212, 0.25), 0 0 22px rgba(50, 167, 255, 0.18);\n    }\n    .tooltip, .map-tooltip, .tree-tooltip, .bubble-tooltip, .heatmap-tooltip {\n      position: fixed;\n      background: rgba(18, 8, 42, 0.92) !important;\n      color: var(--text) !important;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.5), 0 0 20px rgba(255, 59, 212, 0.18), 0 0 26px rgba(50, 167, 255, 0.12);\n      border: 1px solid rgba(50, 167, 255, 0.32);\n      padding: 6px 10px; \n      border-radius: 4px; \n      pointer-events: none;\n      font-size: 13px;\n      z-index: 1000;\n      backdrop-filter: blur(10px);\n    }\n  </style>\n</head>\n<body>\n  <div class=\"title\">${title}</div>\n  <button class=\"close-btn\" onclick=\"window.close()\">å…³é—­çª—å£</button>\n  <div class=\"svg-container\" id=\"svg-container-main\">\n    ${svgString}\n  </div>\n  ${type === 'map' && mapLegendHTML ? `<div class=\"map-legend\" id=\"map-legend\">${mapLegendHTML}</div>` : ``}\n  ${type === 'heatmap' && heatmapLegendHTML ? `<div class=\"heatmap-legend\" id=\"heatmap-legend\">${heatmapLegendHTML}</div>` : ``}\n  ${type === 'heatmap' ? `\n    <details class=\"hm-anno\" id=\"hm-anno\" open>\n      <summary>æ³¨é‡Šï¼ˆç‚¹å‡»éšè—ï¼‰</summary>\n      <div class=\"hm-anno-body\">\n        <div>çƒ­åŠ›å›¾ï¼šä¸–ç•ŒèŒƒå›´éŸ³ä¹çƒ­åº¦å˜åŒ–</div>\n        <div>æŠ˜çº¿å›¾ï¼šå›½å†…ç½‘å‹å¬éŸ³ä¹çš„æ›²ç›®æ•°é‡å˜åŒ–</div>\n      </div>\n    </details>\n  ` : ``}\n\n  ${d3LocalUrl ? `<script src=\"${d3LocalUrl}\"></script>` : ``}\n  ${!d3LocalUrl ? `<script src=\"https://d3js.org/d3.v7.min.js\"></script>` : ``}\n  <script>\n    // âœ… ç¡®ä¿ D3 åŠ è½½å®Œæˆåå†æ‰§è¡Œäº¤äº’è„šæœ¬\n    (function() {\n      function waitForD3(callback, maxAttempts = 50) {\n        if (typeof d3 !== 'undefined') {\n          callback();\n        } else if (maxAttempts > 0) {\n          setTimeout(() => waitForD3(callback, maxAttempts - 1), 100);\n        } else {\n          console.error('âŒ D3 åŠ è½½è¶…æ—¶');\n        }\n      }\n      \n      waitForD3(function() {\n        console.log('âœ… D3 å·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–äº¤äº’...');\n        \n        // æ”¯æŒ ESC é”®å…³é—­\n        document.addEventListener('keydown', function(e) {\n          if (e.key === 'Escape') {\n            window.close();\n          }\n        });\n        \n        // ç¡®ä¿ SVG å…ƒç´ è¢«æ­£ç¡®è¯†åˆ«ï¼ˆä¸æ˜¯å›¾ç‰‡ï¼‰\n        (function ensureSvgIsInteractive() {\n          // âœ… åˆ›å»ºç‹¬ç«‹çš„çƒ­åŠ›å›¾åˆå§‹åŒ–å‡½æ•°\n          function initHeatmapInteractions(svg) {\n            console.log('ğŸ”¥ å¼€å§‹åˆå§‹åŒ–çƒ­åŠ›å›¾äº¤äº’...');\n            if (!svg || typeof d3 === 'undefined') {\n              console.warn('âš ï¸ SVG æˆ– D3 æœªæ‰¾åˆ°ï¼Œæ— æ³•åˆå§‹åŒ–çƒ­åŠ›å›¾äº¤äº’');\n              return;\n            }\n            \n            const svgD3 = d3.select(svg);\n            \n            // âœ… æ£€æµ‹æ˜¯2Dè¿˜æ˜¯3Dçƒ­åŠ›å›¾\n            const cellGroups = svgD3.selectAll('g[class*=\"cell-group\"]');\n            const cells = svgD3.selectAll('rect.cell');\n            const is3DHeatmap = cellGroups.size() > 0;\n            const is2DHeatmap = cells.size() > 0 && cellGroups.size() === 0;\n\n            // âœ… åŸå›¾ä¸éœ€è¦åœ¨å¤§å›¾é¡µé¢å¤–æ˜¾ç¤º 2D/3D å¾½æ ‡ï¼šè¿™é‡Œä¸å†æ³¨å…¥/æ›´æ–°å¾½æ ‡\n            \n            console.log('ğŸ“Š çƒ­åŠ›å›¾ç±»å‹æ£€æµ‹:', {\n              '3Dçƒ­åŠ›å›¾': is3DHeatmap,\n              '2Dçƒ­åŠ›å›¾': is2DHeatmap,\n              'cell-groupæ•°é‡': cellGroups.size(),\n              'rect.cellæ•°é‡': cells.size()\n            });\n            \n            // åˆ›å»º tooltip\n            let tooltip = d3.select(\"body\").select(\".heatmap-tooltip\");\n            if (tooltip.empty()) {\n              tooltip = d3.select(\"body\").append(\"div\")\n                .attr(\"class\", \"heatmap-tooltip\")\n                .style(\"position\", \"fixed\")\n                .style(\"pointer-events\", \"none\")\n                .style(\"opacity\", 0)\n                .style(\"padding\", \"10px 12px\")\n                .style(\"border-radius\", \"12px\")\n                .style(\"background\", \"rgba(30, 41, 59, 0.92)\")\n                .style(\"color\", \"#fff\")\n                .style(\"font\", \"13px/1.35 system-ui, -apple-system, Segoe UI, Microsoft YaHei, sans-serif\")\n                .style(\"box-shadow\", \"0 10px 24px rgba(0,0,0,0.16)\")\n                .style(\"z-index\", 10000)\n                .style(\"backdrop-filter\", \"blur(6px)\")\n                .style(\"border\", \"1px solid rgba(88, 101, 242, 0.5)\");\n            }\n            \n            // âœ… åªä¸º3Dçƒ­åŠ›å›¾ç»‘å®š3Då•å…ƒæ ¼äº‹ä»¶\n            if (is3DHeatmap) {\n              // ä¸ºæ‰€æœ‰ path å…ƒç´ ç»‘å®šäº‹ä»¶ï¼ˆ3Dçƒ­åŠ›å›¾ï¼‰\n              const cellGroupPaths = svgD3.selectAll('g[class*=\"cell-group\"] path');\n              console.log('ğŸ” æ‰¾åˆ° ' + cellGroupPaths.size() + ' ä¸ª cell-group path å…ƒç´ ');\n            \n            cellGroupPaths.each(function() {\n              const path = d3.select(this);\n              const genre = path.attr('data-genre') || path.node().parentElement?.getAttribute('data-genre');\n              const month = path.attr('data-month') || path.node().parentElement?.getAttribute('data-month');\n              const value = path.attr('data-value') || path.node().parentElement?.getAttribute('data-value') || '0';\n              \n              if (genre && month) {\n                const pathNode = path.node();\n                pathNode.style.pointerEvents = 'auto';\n                pathNode.style.cursor = 'pointer';\n                \n                path\n                  .on(\"mouseover\", function(event) {\n                    d3.select(this.parentNode).selectAll(\"path\")\n                      .attr(\"opacity\", 1)\n                      .attr(\"stroke-width\", 1.5);\n                    \n                    // è·å–æ›²ç›®æ•°é‡\n                    const trackCount = path.attr('data-track-count') || Math.round(parseFloat(value));\n                    \n                  tooltip\n                    .style(\"opacity\", 0.95)\n                    .html('<b>' + genre + '</b><br/>' + month + '<br/>åˆ†å€¼: ' + parseFloat(value).toFixed(2) + '<br/>æ›²ç›®æ•°é‡: ' + trackCount);\n                  // fixed tooltip: use clientX/Y to avoid scaling/scroll offset\n                  const cx = (event && typeof event.clientX === \"number\") ? event.clientX : (event && typeof event.pageX === \"number\" ? event.pageX : 0);\n                  const cy = (event && typeof event.clientY === \"number\") ? event.clientY : (event && typeof event.pageY === \"number\" ? event.pageY : 0);\n                  const node = tooltip.node();\n                  const w = node ? (node.offsetWidth || 0) : 0;\n                  const h = node ? (node.offsetHeight || 0) : 0;\n                  const pad = 10;\n                  let x = cx + 12;\n                  let y = cy - 18;\n                  x = Math.max(pad, Math.min(x, (window.innerWidth || 0) - w - pad));\n                  y = Math.max(pad, Math.min(y, (window.innerHeight || 0) - h - pad));\n                  tooltip.style(\"left\", x + \"px\").style(\"top\", y + \"px\");\n                  })\n                  .on(\"mouseout\", function() {\n                    d3.select(this.parentNode).selectAll(\"path\")\n                      .attr(\"opacity\", 0.9)\n                      .attr(\"stroke-width\", 0.5);\n                    tooltip.style(\"opacity\", 0);\n                  });\n              }\n            });\n            \n            }\n            \n            // âœ… åªä¸º2Dçƒ­åŠ›å›¾ç»‘å®š2Då•å…ƒæ ¼äº‹ä»¶\n            if (is2DHeatmap) {\n              console.log('ğŸ” æ‰¾åˆ° ' + cells.size() + ' ä¸ª rect.cell å…ƒç´ ');\n              \n              cells.each(function() {\n              const cell = d3.select(this);\n              const genre = cell.attr('data-genre');\n              const month = cell.attr('data-month');\n              const value = cell.attr('data-value');\n              \n              if (genre && month) {\n                const cellNode = cell.node();\n                cellNode.style.pointerEvents = 'auto';\n                cellNode.style.cursor = 'pointer';\n                \n                cell\n                  .on(\"mousemove\", function(event) {\n                    tooltip\n                      .style(\"opacity\", 1)\n                      .html('<b>' + genre + '</b><br/>' + month + '<br/>Value: ' + value);\n                    const cx = (event && typeof event.clientX === \"number\") ? event.clientX : (event && typeof event.pageX === \"number\" ? event.pageX : 0);\n                    const cy = (event && typeof event.clientY === \"number\") ? event.clientY : (event && typeof event.pageY === \"number\" ? event.pageY : 0);\n                    const node = tooltip.node();\n                    const w = node ? (node.offsetWidth || 0) : 0;\n                    const h = node ? (node.offsetHeight || 0) : 0;\n                    const pad = 10;\n                    let x = cx + 12;\n                    let y = cy - 18;\n                    x = Math.max(pad, Math.min(x, (window.innerWidth || 0) - w - pad));\n                    y = Math.max(pad, Math.min(y, (window.innerHeight || 0) - h - pad));\n                    tooltip.style(\"left\", x + \"px\").style(\"top\", y + \"px\");\n                  })\n                  .on(\"mouseout\", function() {\n                    tooltip.style(\"opacity\", 0);\n                  });\n              }\n            });\n            \n            // âœ… ä¸ºæŠ˜çº¿å›¾ç»‘å®šäº‹ä»¶ï¼ˆline-path å’Œ area-pathï¼‰\n            const linePaths = svgD3.selectAll('path.line-path, path.area-path');\n            console.log('ğŸ” æ‰¾åˆ° ' + linePaths.size() + ' ä¸ªæŠ˜çº¿å›¾ path å…ƒç´ ');\n            \n            linePaths.each(function() {\n              const path = d3.select(this);\n              const month = path.attr('data-month');\n              const lineValuesStr = path.attr('data-line-values');\n              \n              if (month) {\n                try {\n                  const pathNode = path.node();\n                  if (!pathNode) return;\n                  \n                  pathNode.style.pointerEvents = 'auto';\n                  pathNode.style.cursor = 'pointer';\n                  \n                  let lineValues = null;\n                  if (lineValuesStr) {\n                    try {\n                      lineValues = JSON.parse(lineValuesStr);\n                    } catch(e) {\n                      console.warn('æ— æ³•è§£ææŠ˜çº¿æ•°æ® JSON:', e);\n                    }\n                  }\n                  \n                  // ç®€åŒ–ç‰ˆæœ¬ï¼šå¦‚æœé¼ æ ‡åœ¨è·¯å¾„ä¸Šï¼Œæ˜¾ç¤ºæœˆä»½ä¿¡æ¯\n                  path\n                    .on(\"mouseover\", function(event) {\n                      let tooltipHtml = '<b>æŠ˜çº¿å›¾</b><br/>' + month;\n                      \n                      // å¦‚æœæœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå¹³å‡å€¼å’Œå¹³å‡æ›²ç›®æ•°é‡\n                      if (lineValues && lineValues.length > 0) {\n                        const avgValue = lineValues.reduce((sum, d) => sum + (parseFloat(d.value) || 0), 0) / lineValues.length;\n                        const avgTrackCount = Math.round(avgValue);\n                        tooltipHtml += '<br/>å¹³å‡åˆ†å€¼: ' + avgValue.toFixed(2) + '<br/>å¹³å‡æ›²ç›®æ•°é‡: ' + avgTrackCount;\n                      }\n                      \n                      tooltip\n                        .style(\"opacity\", 0.95)\n                        .html(tooltipHtml);\n                      const cx = (event && typeof event.clientX === \"number\") ? event.clientX : (event && typeof event.pageX === \"number\" ? event.pageX : 0);\n                      const cy = (event && typeof event.clientY === \"number\") ? event.clientY : (event && typeof event.pageY === \"number\" ? event.pageY : 0);\n                      const node = tooltip.node();\n                      const w = node ? (node.offsetWidth || 0) : 0;\n                      const h = node ? (node.offsetHeight || 0) : 0;\n                      const pad = 10;\n                      let x = cx + 12;\n                      let y = cy - 18;\n                      x = Math.max(pad, Math.min(x, (window.innerWidth || 0) - w - pad));\n                      y = Math.max(pad, Math.min(y, (window.innerHeight || 0) - h - pad));\n                      tooltip.style(\"left\", x + \"px\").style(\"top\", y + \"px\");\n                    })\n                    .on(\"mousemove\", function(event) {\n                      // æ›´æ–° tooltip ä½ç½®ï¼ˆfixed + clientX/Yï¼‰\n                      const cx = (event && typeof event.clientX === \"number\") ? event.clientX : (event && typeof event.pageX === \"number\" ? event.pageX : 0);\n                      const cy = (event && typeof event.clientY === \"number\") ? event.clientY : (event && typeof event.pageY === \"number\" ? event.pageY : 0);\n                      const node = tooltip.node();\n                      const w = node ? (node.offsetWidth || 0) : 0;\n                      const h = node ? (node.offsetHeight || 0) : 0;\n                      const pad = 10;\n                      let x = cx + 12;\n                      let y = cy - 18;\n                      x = Math.max(pad, Math.min(x, (window.innerWidth || 0) - w - pad));\n                      y = Math.max(pad, Math.min(y, (window.innerHeight || 0) - h - pad));\n                      tooltip.style(\"left\", x + \"px\").style(\"top\", y + \"px\");\n                    })\n                    .on(\"mouseout\", function() {\n                      tooltip.style(\"opacity\", 0);\n                    });\n                } catch(e) {\n                  console.warn('æŠ˜çº¿å›¾äº‹ä»¶ç»‘å®šå‡ºé”™:', e);\n                }\n              }\n            });\n            \n            }\n            \n            // âœ… åªä¸º3Dçƒ­åŠ›å›¾æ·»åŠ 3DæŠ•å½±æ—‹è½¬åŠŸèƒ½ï¼ˆå®Œå…¨æŒ‰ç…§åŸå§‹ä»£ç é‡å†™ï¼‰\n            if (is3DHeatmap) {\n              const g = svgD3.select('g');\n              if (!g.empty()) {\n              // åæ ‡è½´/æ ‡ç­¾ä¸è¦åƒæ‰ hoverï¼ˆå¦åˆ™æŠ˜çº¿ hover å¾ˆéš¾è§¦å‘ï¼‰\n              g.selectAll('.axis-line, .axis-arrow, .axis-label').style('pointer-events', 'none');\n              // 3DæŠ•å½±å‚æ•°\n              const cellWidth = 50;\n              const cellDepth = 25;\n              const maxHeight = 120;\n              const cellThickness = 6;\n              const allGenres = [\"ACG\", \"classical\", \"electronic\", \"folk\", \"jazz\", \"pop\", \"rap\", \"rock\"];\n              const months = ['2023-12', '2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06',\n                '2024-07', '2024-08', '2024-09', '2024-10', '2024-11', '2024-12',\n                '2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06',\n                '2025-07', '2025-08', '2025-09', '2025-10', '2025-11', '2025-12'];\n              const numGenres = allGenres.length;\n              const numMonths = months.length;\n              const totalWidth = numGenres * cellWidth;\n              const totalDepth = numMonths * cellDepth;\n              \n              // æ—‹è½¬è§’åº¦ï¼ˆå…¨å±€å˜é‡ï¼Œæ”¯æŒé¼ æ ‡æ‹–åŠ¨æ—‹è½¬ï¼‰\n              let rotationAngle = Math.PI / 6; // é»˜è®¤30åº¦\n              \n              // ç­‰è½´æµ‹æŠ•å½±å‡½æ•°ï¼ˆæ”¯æŒæ—‹è½¬ï¼‰\n              function isometricProjection(x, y, z) {\n                // ç­‰è½´æµ‹æŠ•å½±ï¼šxè½´å‘å³ï¼Œyè½´å‘å‰ï¼ˆæ·±åº¦ï¼‰ï¼Œzè½´å‘ä¸Š\n                // æ”¯æŒæ°´å¹³æ—‹è½¬ï¼ˆç»•Zè½´ï¼‰\n                const angle = Math.PI / 6; // åŸºç¡€ç­‰è½´æµ‹è§’åº¦30åº¦\n                const scale = 1.2; // ç¨å¾®æ”¾å¤§ä¸€ç‚¹ï¼Œè®©3Dæ•ˆæœæ›´æ˜æ˜¾\n                \n                // åº”ç”¨æ°´å¹³æ—‹è½¬\n                const cosR = Math.cos(rotationAngle);\n                const sinR = Math.sin(rotationAngle);\n                const rotatedX = x * cosR - y * sinR;\n                const rotatedY = x * sinR + y * cosR;\n                \n                // ç­‰è½´æµ‹æŠ•å½±\n                const isoX = (rotatedX - rotatedY) * Math.cos(angle) * scale;\n                const isoY = (rotatedX + rotatedY) * Math.sin(angle) * scale - z * scale;\n                return { x: isoX, y: isoY };\n              }\n              \n              // âœ… ä»SVGä¸­æå–å•å…ƒæ ¼æ•°æ®\n              const cellDataArray = [];\n              const cellGroups = g.selectAll('g[class*=\"cell-group\"]');\n              \n              console.log('ğŸ” æ‰¾åˆ° ' + cellGroups.size() + ' ä¸ª cell-group å…ƒç´ ');\n              \n              // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•å…¶ä»–é€‰æ‹©å™¨\n              let actualGroups = cellGroups;\n              if (cellGroups.size() === 0) {\n                actualGroups = g.selectAll('g').filter(function() {\n                  const group = d3.select(this);\n                  const classAttr = group.attr('class') || '';\n                  return classAttr.includes('cell-group') || classAttr.match(/cell-\\d+-\\d+/);\n                });\n                console.log('ğŸ” ä½¿ç”¨å¤‡ç”¨é€‰æ‹©å™¨æ‰¾åˆ° ' + actualGroups.size() + ' ä¸ªå…ƒç´ ');\n              }\n              \n              actualGroups.each(function() {\n                const group = d3.select(this);\n                const classAttr = group.attr('class') || '';\n                const monthIdxAttr = group.attr('data-month-idx');\n                const genreIdxAttr = group.attr('data-genre-idx');\n                \n                let monthIdx = null;\n                let genreIdx = null;\n                \n                // ä¼˜å…ˆä»dataå±æ€§è·å–\n                if (monthIdxAttr !== null && genreIdxAttr !== null) {\n                  monthIdx = parseInt(monthIdxAttr);\n                  genreIdx = parseInt(genreIdxAttr);\n                } else {\n                  // ä»classä¸­æå–\n                  const match = classAttr.match(/cell-(\\d+)-(\\d+)/);\n                  if (match) {\n                    monthIdx = parseInt(match[1]);\n                    genreIdx = parseInt(match[2]);\n                  }\n                }\n                \n                if (monthIdx !== null && genreIdx !== null && !isNaN(monthIdx) && !isNaN(genreIdx)) {\n                  const value = parseFloat(group.attr('data-value') || '0');\n                  \n                  // è®¡ç®—3Dåæ ‡\n                  const x = genreIdx * cellWidth;\n                  const y = monthIdx * cellDepth;\n                  const zBottom = 0;\n                  const zTop = cellThickness;\n                  \n                  // è·å–é¢œè‰²ï¼ˆä»ç¬¬ä¸€ä¸ªpathå…ƒç´ ï¼‰\n                  const firstPath = group.select('path').node();\n                  const fillColor = firstPath ? firstPath.getAttribute('fill') : '#ccc';\n                  \n                  cellDataArray.push({\n                    monthIdx: monthIdx,\n                    genreIdx: genreIdx,\n                    x: x,\n                    y: y,\n                    zBottom: zBottom,\n                    zTop: zTop,\n                    value: value,\n                    fillColor: fillColor,\n                    group: group\n                  });\n                } else {\n                  // è°ƒè¯•ï¼šè¾“å‡ºå‰å‡ ä¸ªæ— æ³•åŒ¹é…çš„å…ƒç´ \n                  if (cellDataArray.length < 3) {\n                    console.warn('âš ï¸ æ— æ³•æå–æ•°æ® - class:', classAttr, 'data-month-idx:', monthIdxAttr, 'data-genre-idx:', genreIdxAttr);\n                  }\n                }\n              });\n              \n              console.log('ğŸ“Š æå–äº† ' + cellDataArray.length + ' ä¸ªå•å…ƒæ ¼çš„3Dæ•°æ®');\n              \n              if (cellDataArray.length === 0) {\n                console.error('âŒ æœªèƒ½æå–ä»»ä½•å•å…ƒæ ¼æ•°æ®ï¼è¯·æ£€æŸ¥æ•°æ®å±æ€§æ˜¯å¦æ­£ç¡®å­˜å‚¨ã€‚');\n              }\n              \n              // âœ… ä»SVGä¸­æå–æŠ˜çº¿å›¾æ•°æ®\n              const lineDataArray = [];\n              const linePaths = g.selectAll('path.line-path');\n              \n              linePaths.each(function() {\n                const path = d3.select(this);\n                const monthIdxStr = path.attr('data-month-idx');\n                const lineValuesStr = path.attr('data-line-values');\n                \n                if (monthIdxStr !== null && lineValuesStr) {\n                  try {\n                    const monthIdx = parseInt(monthIdxStr);\n                    const lineValues = JSON.parse(lineValuesStr);\n                    const monthY = monthIdx * cellDepth + cellDepth / 2;\n                    \n                    // é‡å»ºæŠ˜çº¿çš„3Dåæ ‡æ•°æ®\n                    const lineData = [];\n                    let minLineHeight = Infinity;\n                    let maxLineHeight = -Infinity;\n                    \n                    // å…ˆæ‰¾åˆ°æœ€å°å’Œæœ€å¤§å€¼\n                    lineValues.forEach(function(d) {\n                      const val = parseFloat(d.value || 0);\n                      if (val < minLineHeight) minLineHeight = val;\n                      if (val > maxLineHeight) maxLineHeight = val;\n                    });\n                    \n                    if (minLineHeight === Infinity) minLineHeight = 0;\n                    if (maxLineHeight === 0) maxLineHeight = 1;\n                    const lineHeightRange = maxLineHeight - minLineHeight || 1;\n                    const maxLineZ = maxHeight * 1.2;\n                    \n                    // é‡å»ºæ¯ä¸ªæ•°æ®ç‚¹\n                    lineValues.forEach(function(d, genreIdx) {\n                      const value = parseFloat(d.value || 0);\n                      const normalizedValue = lineHeightRange > 0 ? (value - minLineHeight) / lineHeightRange : 0;\n                      const z = cellThickness + (isNaN(normalizedValue) ? 0 : normalizedValue) * maxLineZ;\n                      const genreX = genreIdx * cellWidth + cellWidth / 2;\n                      \n                      if (!isNaN(genreX) && !isNaN(monthY) && !isNaN(z)) {\n                        lineData.push({\n                          x: genreX,\n                          y: monthY,\n                          z: z,\n                          value: value,\n                          monthIdx: monthIdx,\n                          genreIdx: genreIdx\n                        });\n                      }\n                    });\n                    \n                    if (lineData.length > 0) {\n                      lineDataArray.push({\n                        monthIdx: monthIdx,\n                        lineData: lineData,\n                        linePath: path,\n                        areaPath: g.select('.area-path.area-' + monthIdx)\n                      });\n                    }\n                  } catch(e) {\n                    console.warn('æ— æ³•è§£ææŠ˜çº¿æ•°æ®:', e);\n                  }\n                }\n              });\n              \n              console.log('ğŸ“Š æå–äº† ' + lineDataArray.length + ' æ¡æŠ˜çº¿çš„3Dæ•°æ®');\n              \n              // åæ ‡è½´ç›¸å…³å˜é‡ï¼ˆä¸åŸå§‹ä»£ç ä¸€è‡´ï¼‰\n              const axisOffset = 8;\n              const labelOffset = 40;\n              let origin = isometricProjection(-axisOffset, -axisOffset, 0);\n              let xAxisEnd = isometricProjection(totalWidth + axisOffset, -axisOffset, 0);\n              let yAxisEnd = isometricProjection(-axisOffset, totalDepth + axisOffset, 0);\n              let zAxisEnd = isometricProjection(-axisOffset, -axisOffset, maxHeight + axisOffset);\n              let zLabelPos = isometricProjection(-10, 0, maxHeight + 25);\n              \n              // âœ… æ›´æ–°æŠ•å½±å‡½æ•°ï¼ˆé‡æ–°è®¡ç®—æ‰€æœ‰å…ƒç´ çš„ä½ç½®ï¼‰\n              function updateProjection() {\n                // é‡æ–°è®¡ç®—è¾¹ç•Œ\n                const corners = [\n                  isometricProjection(0, 0, 0),\n                  isometricProjection(totalWidth, 0, 0),\n                  isometricProjection(0, totalDepth, 0),\n                  isometricProjection(totalWidth, totalDepth, 0),\n                  isometricProjection(0, 0, maxHeight),\n                  isometricProjection(totalWidth, 0, maxHeight)\n                ];\n                \n                const minX = d3.min(corners, d => d.x);\n                const maxX = d3.max(corners, d => d.x);\n                const minY = d3.min(corners, d => d.y);\n                const maxY = d3.max(corners, d => d.y);\n                \n                const projectedWidth = maxX - minX;\n                const projectedHeight = maxY - minY;\n                \n                // æ›´æ–° viewBox\n                const padding = 50;\n                const viewBoxMinX = minX - padding;\n                const viewBoxMinY = minY - padding;\n                const viewBoxWidth = projectedWidth + padding * 2;\n                const viewBoxHeight = projectedHeight + padding * 2;\n                \n                svgD3.attr(\"viewBox\", viewBoxMinX + ' ' + viewBoxMinY + ' ' + viewBoxWidth + ' ' + viewBoxHeight);\n                \n                // æ›´æ–°æ‰€æœ‰å•å…ƒæ ¼\n                cellDataArray.forEach(cellData => {\n                  const { x, y, zBottom, zTop, monthIdx, genreIdx } = cellData;\n                  \n                  // é‡æ–°è®¡ç®—8ä¸ªé¡¶ç‚¹\n                  const bottom1 = isometricProjection(x, y, zBottom);\n                  const bottom2 = isometricProjection(x + cellWidth, y, zBottom);\n                  const bottom3 = isometricProjection(x + cellWidth, y + cellDepth, zBottom);\n                  const bottom4 = isometricProjection(x, y + cellDepth, zBottom);\n                  const top1 = isometricProjection(x, y, zTop);\n                  const top2 = isometricProjection(x + cellWidth, y, zTop);\n                  const top3 = isometricProjection(x + cellWidth, y + cellDepth, zTop);\n                  const top4 = isometricProjection(x, y + cellDepth, zTop);\n                  \n                  // æ›´æ–°å•å…ƒæ ¼ç»„çš„æ‰€æœ‰é¢\n                  const cellGroup = g.select('.cell-' + monthIdx + '-' + genreIdx);\n                  if (!cellGroup.empty()) {\n                    const paths = cellGroup.selectAll(\"path\");\n                    const faces = [\n                      [bottom1, bottom2, bottom3, bottom4], // åº•é¢\n                      [bottom2, top2, top3, bottom3], // å³ä¾§é¢\n                      [bottom4, bottom3, top3, top4], // èƒŒé¢\n                      [top1, top2, top3, top4] // é¡¶é¢\n                    ];\n                    \n                    paths.each(function(d, i) {\n                      if (i < faces.length) {\n                        const path = d3.path();\n                        path.moveTo(faces[i][0].x, faces[i][0].y);\n                        for (let j = 1; j < faces[i].length; j++) {\n                          path.lineTo(faces[i][j].x, faces[i][j].y);\n                        }\n                        path.closePath();\n                        d3.select(this).attr(\"d\", path.toString());\n                      }\n                    });\n                  }\n                });\n                \n                // æ›´æ–°æ‰€æœ‰æŠ˜çº¿\n                lineDataArray.forEach(({ monthIdx, lineData, darkerLineColor }) => {\n                  // é‡æ–°ç”ŸæˆæŠ˜çº¿è·¯å¾„ï¼ˆä½¿ç”¨ä¸åˆå§‹åŒ–æ—¶ç›¸åŒçš„lineGeneratoré€»è¾‘ï¼‰\n                  // æ³¨æ„ï¼šéœ€è¦æŒ‰ç…§æŠ•å½±åçš„Xåæ ‡æ’åºï¼Œç¡®ä¿æ›²çº¿æ–¹å‘æ­£ç¡®\n                  const sortedLineData = [...lineData].sort((a, b) => {\n                    const projA = isometricProjection(a.x, a.y, a.z);\n                    const projB = isometricProjection(b.x, b.y, b.z);\n                    return projA.x - projB.x;\n                  });\n                  \n                  const lineGeneratorUpdate = d3.line()\n                    .curve(d3.curveMonotoneX)\n                    .x(function(d) {\n                      const projected = isometricProjection(d.x, d.y, d.z);\n                      return projected.x;\n                    })\n                    .y(function(d) {\n                      const projected = isometricProjection(d.x, d.y, d.z);\n                      return projected.y;\n                    });\n                  \n                  // æ›´æ–°æŠ˜çº¿ï¼ˆä½¿ç”¨æ­£ç¡®çš„é€‰æ‹©å™¨ï¼Œclassæ˜¯ \"line-path line-monthIdx\"ï¼‰\n                  const lineElement = g.select(\".line-path.line-\" + monthIdx);\n                  if (!lineElement.empty()) {\n                    const newPath = lineGeneratorUpdate(sortedLineData);\n                    if (newPath && !newPath.includes('NaN')) {\n                      lineElement.attr(\"d\", newPath);\n                    }\n                  }\n                  \n                  // æ›´æ–°é¢ç§¯å¡«å……ï¼ˆé‡æ–°åˆ›å»ºareaGeneratorï¼Œå› ä¸ºæŠ•å½±å‡½æ•°å·²æ›´æ–°ï¼‰\n                  // ä½¿ç”¨æ’åºåçš„æ•°æ®ï¼Œç¡®ä¿ä¸æŠ˜çº¿ä¸€è‡´\n                  const areaGeneratorUpdate = d3.area()\n                    .curve(d3.curveMonotoneX)\n                    .x(function(d) {\n                      const projected = isometricProjection(d.x, d.y, d.z);\n                      return projected.x;\n                    })\n                    .y0(function(d) {\n                      const projected = isometricProjection(d.x, d.y, cellThickness);\n                      return projected.y;\n                    })\n                    .y1(function(d) {\n                      const projected = isometricProjection(d.x, d.y, d.z);\n                      return projected.y;\n                    });\n                  \n                  const areaElement = g.select(\".area-\" + monthIdx);\n                  if (!areaElement.empty()) {\n                    areaElement.attr(\"d\", areaGeneratorUpdate(sortedLineData));\n                  }\n                  \n                  // æ›´æ–°æœ€é«˜ç‚¹æ ‡è®°\n                  let maxZ = -Infinity;\n                  let maxPoint = null;\n                  lineData.forEach(point => {\n                    if (point.z > maxZ) {\n                      maxZ = point.z;\n                      maxPoint = point;\n                    }\n                  });\n                  \n                  if (maxPoint) {\n                    const maxProjected = isometricProjection(maxPoint.x, maxPoint.y, maxPoint.z);\n                    g.select('.max-point-outer-' + monthIdx)\n                      .attr(\"cx\", maxProjected.x)\n                      .attr(\"cy\", maxProjected.y);\n                    g.select('.max-point-inner-' + monthIdx)\n                      .attr(\"cx\", maxProjected.x)\n                      .attr(\"cy\", maxProjected.y);\n                  }\n                });\n                \n                // æ›´æ–°åæ ‡è½´ï¼ˆä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„axisOffsetå’ŒlabelOffsetï¼‰\n                \n                // æ›´æ–°åŸç‚¹\n                origin = isometricProjection(-axisOffset, -axisOffset, 0);\n                \n                // æ›´æ–°Xè½´\n                xAxisEnd = isometricProjection(totalWidth + axisOffset, -axisOffset, 0);\n                g.select(\".x-axis.axis-line\")\n                  .attr(\"x1\", origin.x)\n                  .attr(\"y1\", origin.y)\n                  .attr(\"x2\", xAxisEnd.x)\n                  .attr(\"y2\", xAxisEnd.y);\n                \n                const xAxisAngle = Math.atan2(xAxisEnd.y - origin.y, xAxisEnd.x - origin.x);\n                const xArrowLength = 8;\n                const xArrowPath = d3.path();\n                xArrowPath.moveTo(xAxisEnd.x, xAxisEnd.y);\n                xArrowPath.lineTo(\n                  xAxisEnd.x - xArrowLength * Math.cos(xAxisAngle - Math.PI / 6),\n                  xAxisEnd.y - xArrowLength * Math.sin(xAxisAngle - Math.PI / 6)\n                );\n                xArrowPath.lineTo(\n                  xAxisEnd.x - xArrowLength * Math.cos(xAxisAngle + Math.PI / 6),\n                  xAxisEnd.y - xArrowLength * Math.sin(xAxisAngle + Math.PI / 6)\n                );\n                xArrowPath.closePath();\n                g.select(\".x-axis.axis-arrow\").attr(\"d\", xArrowPath.toString());\n                \n                // æ›´æ–°Yè½´\n                yAxisEnd = isometricProjection(-axisOffset, totalDepth + axisOffset, 0);\n                g.select(\".y-axis.axis-line\")\n                  .attr(\"x1\", origin.x)\n                  .attr(\"y1\", origin.y)\n                  .attr(\"x2\", yAxisEnd.x)\n                  .attr(\"y2\", yAxisEnd.y);\n                \n                const yAxisAngle = Math.atan2(yAxisEnd.y - origin.y, yAxisEnd.x - origin.x);\n                const yArrowLength = 8;\n                const yArrowPath = d3.path();\n                yArrowPath.moveTo(yAxisEnd.x, yAxisEnd.y);\n                yArrowPath.lineTo(\n                  yAxisEnd.x - yArrowLength * Math.cos(yAxisAngle - Math.PI / 6),\n                  yAxisEnd.y - yArrowLength * Math.sin(yAxisAngle - Math.PI / 6)\n                );\n                yArrowPath.lineTo(\n                  yAxisEnd.x - yArrowLength * Math.cos(yAxisAngle + Math.PI / 6),\n                  yAxisEnd.y - yArrowLength * Math.sin(yAxisAngle + Math.PI / 6)\n                );\n                yArrowPath.closePath();\n                g.select(\".y-axis.axis-arrow\").attr(\"d\", yArrowPath.toString());\n                \n                // æ›´æ–°Zè½´\n                zAxisEnd = isometricProjection(-axisOffset, -axisOffset, maxHeight + axisOffset);\n                g.select(\".z-axis.axis-line\")\n                  .attr(\"x1\", origin.x)\n                  .attr(\"y1\", origin.y)\n                  .attr(\"x2\", zAxisEnd.x)\n                  .attr(\"y2\", zAxisEnd.y);\n                \n                const zAxisAngle = Math.atan2(zAxisEnd.y - origin.y, zAxisEnd.x - origin.x);\n                const zArrowLength = 8;\n                const zArrowPath = d3.path();\n                zArrowPath.moveTo(zAxisEnd.x, zAxisEnd.y);\n                zArrowPath.lineTo(\n                  zAxisEnd.x - zArrowLength * Math.cos(zAxisAngle - Math.PI / 6),\n                  zAxisEnd.y - zArrowLength * Math.sin(zAxisAngle - Math.PI / 6)\n                );\n                zArrowPath.lineTo(\n                  zAxisEnd.x - zArrowLength * Math.cos(zAxisAngle + Math.PI / 6),\n                  zAxisEnd.y - zArrowLength * Math.sin(zAxisAngle + Math.PI / 6)\n                );\n                zArrowPath.closePath();\n                g.select(\".z-axis.axis-arrow\").attr(\"d\", zArrowPath.toString());\n                \n                // æ›´æ–°Xè½´æ ‡ç­¾\n                allGenres.forEach((genre, idx) => {\n                  const x = idx * cellWidth + cellWidth / 2;\n                  const y = -labelOffset;\n                  const projected = isometricProjection(x, y, 0);\n                  g.select('.x-label-' + idx)\n                    .attr(\"x\", projected.x)\n                    .attr(\"y\", projected.y);\n                });\n                \n                // æ›´æ–°Yè½´æ ‡ç­¾\n                months.forEach((month, idx) => {\n                  if (idx % 3 === 0) {\n                    const x = 0;\n                    const y = idx * cellDepth + cellDepth / 2;\n                    const projected = isometricProjection(x - labelOffset, y, 0);\n                    g.select('.y-label-' + idx)\n                      .attr(\"x\", projected.x)\n                      .attr(\"y\", projected.y);\n                  }\n                });\n                \n                // æ›´æ–°Zè½´æ ‡ç­¾\n                zLabelPos = isometricProjection(-10, 0, maxHeight + 25);\n                g.select(\".z-label\")\n                  .attr(\"x\", zLabelPos.x)\n                  .attr(\"y\", zLabelPos.y);\n                \n              }\n              \n              // é¼ æ ‡æ‹–åŠ¨æ—‹è½¬ç›¸å…³å˜é‡ï¼ˆä¸åŸå§‹ heatmap.js ä¸€è‡´ï¼‰\n              let isDragging = false;\n              let lastMouseX = 0;\n\n              // ========== é¼ æ ‡æ‹–åŠ¨æ—‹è½¬äº‹ä»¶ ==========\n              svgD3.on(\"mousedown\", function(event) {\n                isDragging = true;\n                lastMouseX = event.clientX;\n                svgD3.style(\"cursor\", \"grabbing\");\n                event.preventDefault();\n                event.stopPropagation();\n              });\n\n              svgD3.on(\"mousemove\", function(event) {\n                if (isDragging) {\n                  const deltaX = event.clientX - lastMouseX;\n                  rotationAngle += deltaX * 0.01; // æ—‹è½¬é€Ÿåº¦\n                  \n                  // æ›´æ–°æŠ•å½±ï¼ˆåŒæ­¥ï¼Œé¿å… mouseup åä»æœ‰å¼‚æ­¥æ›´æ–°å¯¼è‡´â€œæ¾å¼€è¿˜åœ¨è½¬â€ï¼‰\n                  updateProjection();\n                  \n                  lastMouseX = event.clientX;\n                  event.preventDefault();\n                  event.stopPropagation();\n                } else {\n                  // âœ… å…œåº•ï¼šå¤§çª—é‡Œä¸ä¾èµ–å‘½ä¸­æŠ˜çº¿æœ¬ä½“ï¼Œé è¿‘æŠ˜çº¿ç‚¹å°±æ˜¾ç¤º tooltip\n                  try {\n                    const gNode = g.node();\n                    if (!gNode) return;\n                    const m = d3.pointer(event, gNode);\n                    const mouseX = m[0], mouseY = m[1];\n\n                    let best = null;\n                    for (let mi = 0; mi < lineDataArray.length; mi++) {\n                      const series = lineDataArray[mi];\n                      if (!series || !series.lineData) continue;\n                      for (let gi = 0; gi < series.lineData.length; gi++) {\n                        const p = series.lineData[gi];\n                        const proj = isometricProjection(p.x, p.y, p.z);\n                        const dx = mouseX - proj.x;\n                        const dy = mouseY - proj.y;\n                        const dist = Math.sqrt(dx * dx + dy * dy);\n                        if (!best || dist < best.dist) {\n                          const monthLabel = (typeof months !== 'undefined' && months && months[p.monthIdx] !== undefined) ? months[p.monthIdx] : (series.month || '');\n                          best = { month: monthLabel, genre: allGenres[p.genreIdx], value: p.value, dist };\n                        }\n                      }\n                    }\n\n                    if (best && best.dist < 22) {\n                      tooltip.style(\"opacity\", 0.95).html('<b>' + best.genre + '</b><br/>' + best.month + '<br/>æ›²ç›®æ•°é‡: ' + Math.round(best.value));\n                      const cx = (event && typeof event.clientX === \"number\") ? event.clientX : (event && typeof event.pageX === \"number\" ? event.pageX : 0);\n                      const cy = (event && typeof event.clientY === \"number\") ? event.clientY : (event && typeof event.pageY === \"number\" ? event.pageY : 0);\n                      const node = tooltip.node();\n                      const w = node ? (node.offsetWidth || 0) : 0;\n                      const h = node ? (node.offsetHeight || 0) : 0;\n                      const pad = 10;\n                      let x = cx + 12;\n                      let y = cy - 18;\n                      x = Math.max(pad, Math.min(x, (window.innerWidth || 0) - w - pad));\n                      y = Math.max(pad, Math.min(y, (window.innerHeight || 0) - h - pad));\n                      tooltip.style(\"left\", x + \"px\").style(\"top\", y + \"px\");\n                    } else {\n                      // ä¸é è¿‘æŠ˜çº¿æ—¶ä¸å¼ºè¡Œéšè—ï¼Œé¿å…å’Œæ–¹å— tooltip æ‰“æ¶\n                    }\n                  } catch (e) {}\n                }\n              });\n\n              svgD3.on(\"mouseup\", function(event) {\n                isDragging = false;\n                svgD3.style(\"cursor\", \"grab\");\n                event.preventDefault();\n                event.stopPropagation();\n              });\n\n              svgD3.on(\"mouseleave\", function(event) {\n                isDragging = false;\n                svgD3.style(\"cursor\", \"grab\");\n                event.preventDefault();\n                event.stopPropagation();\n              });\n              \n              // å…¨å±€ mouseup ç›‘å¬ï¼Œç¡®ä¿å³ä½¿é¼ æ ‡ç§»å‡º SVG ä¹Ÿèƒ½åœæ­¢æ‹–åŠ¨\n              d3.select(document).on(\"mouseup.heatmap-rotate\", function(event) {\n                if (isDragging) {\n                  isDragging = false;\n                  svgD3.style(\"cursor\", \"grab\");\n                }\n              });\n              }\n            } else if (is2DHeatmap) {\n              // âœ… 2Dçƒ­åŠ›å›¾ï¼šåªæ·»åŠ ç®€å•çš„ç¼©æ”¾åŠŸèƒ½ï¼ˆä¸æ—‹è½¬ï¼‰\n              const g = svgD3.select('g');\n              if (!g.empty()) {\n                const zoom = d3.zoom()\n                  .scaleExtent([0.5, 3])\n                  .on(\"zoom\", function(event) {\n                    g.attr(\"transform\", event.transform);\n                  });\n                \n                svgD3.call(zoom);\n                console.log('âœ… 2Dçƒ­åŠ›å›¾ç¼©æ”¾åŠŸèƒ½å·²å¯ç”¨');\n              }\n            }\n            \n            console.log('âœ… çƒ­åŠ›å›¾äº¤äº’åˆå§‹åŒ–å®Œæˆ');\n          }\n          \n          function checkSvg() {\n            const svg = document.querySelector('#svg-container-main svg') || document.querySelector('svg');\n            if (svg) {\n              console.log('âœ… SVG å…ƒç´ å·²æ‰¾åˆ°:', svg.tagName, svg.namespaceURI);\n              // ç¡®ä¿ SVG æœ‰æ­£ç¡®çš„å‘½åç©ºé—´ï¼ˆå…³é”®ï¼ï¼‰\n              svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n              svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');\n              \n              // ç§»é™¤å¯èƒ½è¢«è¯¯è¯†åˆ«ä¸ºå›¾ç‰‡çš„å±æ€§\n              svg.removeAttribute('content-type');\n              svg.removeAttribute('content');\n              svg.removeAttribute('type');\n              \n              // ç¡®ä¿ SVG å¯ä»¥æ¥æ”¶äº‹ä»¶ï¼ˆä¸æ˜¯å›¾ç‰‡ï¼‰\n              svg.style.pointerEvents = 'auto';\n              \n              // ç¡®ä¿æ‰€æœ‰å­å…ƒç´ ä¹Ÿå¯ä»¥æ¥æ”¶äº‹ä»¶\n              const allElements = svg.querySelectorAll('*');\n              allElements.forEach(el => {\n                el.style.pointerEvents = 'auto';\n              });\n              \n              console.log('âœ… SVG å·²è®¾ç½®ä¸ºå¯äº¤äº’æ¨¡å¼');\n              \n              // âœ… å¦‚æœæ˜¯çƒ­åŠ›å›¾ï¼Œç›´æ¥åœ¨è¿™é‡Œåˆå§‹åŒ–\n              const chartType = '${type}';\n              console.log('ğŸ“ å›¾è¡¨ç±»å‹:', chartType);\n              if (chartType === 'heatmap') {\n                console.log('ğŸ”¥ æ£€æµ‹åˆ°çƒ­åŠ›å›¾ç±»å‹ï¼Œå¼€å§‹åˆå§‹åŒ–...');\n                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“\n                setTimeout(function() {\n                  initHeatmapInteractions(svg);\n                }, 100);\n              }\n              \n              return true;\n            } else {\n              console.warn('âš ï¸ æœªæ‰¾åˆ° SVG å…ƒç´ ï¼Œç­‰å¾…...');\n              return false;\n            }\n          }\n          \n          // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ DOM å®Œå…¨æ¸²æŸ“\n          setTimeout(function() {\n            const svgFound = checkSvg();\n            if (!svgFound) {\n              // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œç­‰å¾… DOM åŠ è½½å®Œæˆ\n              if (document.readyState === 'loading') {\n                document.addEventListener('DOMContentLoaded', function() {\n                  setTimeout(function() {\n                    checkSvg();\n                  }, 200);\n                });\n              } else {\n                setTimeout(function() {\n                  checkSvg();\n                }, 200);\n              }\n            }\n          }, 500);\n          \n          // çƒ­åŠ›å›¾ä¸å†åšâ€œå»¶è¿Ÿä¿éšœâ€äºŒæ¬¡åˆå§‹åŒ–ï¼šé¿å…é‡å¤ç»‘å®šäº‹ä»¶/zoom æŠ¢äº‹ä»¶å¯¼è‡´æ—‹è½¬é€»è¾‘é”™ä¹±\n        })();\n      });\n    })();\n  </script>\n  ${interactionScript ? interactionScript.replace('<script>', '<script data-type=\"' + type + '\">') : ''}\n</body>\n</html>\n    `;\n  }\n  //#endregion\n\n  function initInteractionsInNewWindow(newWindow, type) {\n    // åœ¨æ–°çª—å£ä¸­åˆå§‹åŒ–äº¤äº’åŠŸèƒ½\n    // è¿™ä¸ªå‡½æ•°ä¼šåœ¨çª—å£åŠ è½½å®Œæˆåè¢«è°ƒç”¨\n    // å…·ä½“çš„äº¤äº’é€»è¾‘å·²ç»åœ¨ HTML çš„ script æ ‡ç­¾ä¸­\n  }\n\n  function openImageInNewWindow(imageSrc, title) {\n    // åˆ›å»ºæ–°çª—å£çš„ HTMLï¼Œæ˜¾ç¤ºå›¾ç‰‡\n    const html = `\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${title} - è¯¦ç»†è§†å›¾</title>\n  <style>\n    * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n    }\n    :root{\n      /* æ–°çª—å£èƒŒæ™¯ï¼šæ¯”ä¸»é¡µé¢æ›´æµ…ä¸€æ¡£ï¼Œé¿å…â€œå¤ªé»‘â€ */\n      --bg: #0b0624;\n      --bg-0: #0b0624;\n      --bg-1: #140a35;\n      --bg-2: #1c0c44;\n      --bg-3: #0b1230;\n      --text: #e2e8f0;\n      --muted: #94a3b8;\n      --accent-violet: #7c3aed;\n      --accent-pink: #ff3bd4;\n      --accent-blue: #32a7ff;\n    }\n    html, body {\n      width: 100%;\n      height: 100%;\n      overflow: auto;\n      background:\n        radial-gradient(circle at 18% 28%, rgba(255, 59, 212, 0.12) 0%, transparent 54%),\n        radial-gradient(circle at 82% 68%, rgba(50, 167, 255, 0.11) 0%, transparent 56%),\n        linear-gradient(135deg, var(--bg-0) 0%, var(--bg-1) 28%, var(--bg-2) 58%, var(--bg-3) 100%);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n    .image-container {\n      width: 100%;\n      height: 100%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 20px;\n    }\n    img {\n      max-width: 100%;\n      max-height: 100%;\n      object-fit: contain;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n      border-radius: 8px;\n    }\n    .close-btn {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: rgba(18, 8, 42, 0.82);\n      color: var(--text);\n      border: 1px solid rgba(50, 167, 255, 0.32);\n      padding: 8px 16px;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 14px;\n      z-index: 1000;\n      transition: all 0.3s ease;\n    }\n    .close-btn:hover {\n      background: rgba(255, 59, 212, 0.14);\n      border-color: rgba(255, 59, 212, 0.42);\n    }\n    .title {\n      position: fixed;\n      top: 20px;\n      left: 20px;\n      color: var(--text);\n      font-size: 18px;\n      font-weight: 600;\n      z-index: 1000;\n      text-shadow: 0 0 12px rgba(255, 59, 212, 0.25), 0 0 22px rgba(50, 167, 255, 0.18);\n    }\n  </style>\n</head>\n<body>\n  <div class=\"title\">${title}</div>\n  <button class=\"close-btn\" onclick=\"window.close()\">å…³é—­çª—å£</button>\n  <div class=\"image-container\">\n    <img src=\"${imageSrc}\" alt=\"${title}\">\n  </div>\n  <script>\n    // æ”¯æŒ ESC é”®å…³é—­\n    document.addEventListener('keydown', function(e) {\n      if (e.key === 'Escape') {\n        window.close();\n      }\n    });\n    \n    // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†\n    document.querySelector('img').addEventListener('error', function() {\n      this.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';\n      this.style.border = '2px solid rgba(220, 38, 38, 0.5)';\n    });\n  </script>\n</body>\n</html>\n    `;\n\n    // æ‰“å¼€æ–°çª—å£\n    const newWindow = window.open('', '_blank', 'width=1400,height=900,resizable=yes,scrollbars=yes');\n    if (newWindow) {\n      newWindow.document.write(html);\n      newWindow.document.close();\n    } else {\n      alert('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');\n    }\n  }\n\n  function addGlobalStyles() {\n    const styleId = 'svg-interaction-styles';\n    if (document.getElementById(styleId)) return;\n\n    const style = document.createElement('style');\n    style.id = styleId;\n    style.textContent = `\n      .chart-content[data-interaction-setup] {\n        transform-origin: center center;\n        will-change: transform;\n      }\n      .chart-panel {\n        overflow: visible !important;\n      }\n      .chart-content[data-interaction-setup]:hover {\n        z-index: 100 !important;\n      }\n    `;\n    document.head.appendChild(style);\n  }\n\n  init();\n})();\n"]}